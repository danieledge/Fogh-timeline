<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Admin Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a3e;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 {
            color: #f0f0f0;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            color: #a0a0a0;
            font-size: 1.1rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 15px;
            border-radius: 15px;
            overflow-x: auto;
            border: 1px solid #2a2a3e;
        }

        .tab-button {
            background: rgba(255,255,255,0.05);
            color: #a0a0a0;
            border: 1px solid #3a3a4e;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.1);
            color: #f0f0f0;
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #4a69bd 0%, #3c5a99 100%);
            color: white;
            border-color: #5a7bc4;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tool-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a3e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            border-color: #3a3a4e;
        }

        .tool-card h2 {
            color: #f0f0f0;
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a2a3e;
        }

        .tool-description {
            color: #a0a0a0;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(135deg, #4a69bd 0%, #3c5a99 100%);
            color: white;
            border: 1px solid #5a7bc4;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #5a79cd 0%, #4c6aa9 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 105, 189, 0.3);
            border-color: #6a8bd4;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%);
            border-color: #9e54bd;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #9e54bd 0%, #7c4493 100%);
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.3);
            border-color: #ae64cd;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            border-color: #37be70;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #37be70 0%, #2e9459 100%);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            border-color: #47ce80;
        }

        .btn-warning {
            background: linear-gradient(135deg, #e67e22 0%, #c65d02 100%);
            border-color: #f68e32;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #f68e32 0%, #d66d12 100%);
            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3);
            border-color: #ff9e42;
        }

        .output-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a3e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            position: relative;
        }

        .output-section.active {
            display: block;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2a2a3e;
            flex-wrap: wrap;
            gap: 10px;
        }

        .output-title {
            font-size: 1.3rem;
            color: #f0f0f0;
        }

        .output-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .output-content {
            background: #0d0d1d;
            border: 1px solid #2a2a3e;
            border-radius: 8px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            color: #d0d0d0;
            position: relative;
        }

        /* Better iOS selection support */
        .output-content {
            -webkit-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }

        .output-content::-webkit-scrollbar {
            width: 10px;
        }

        .output-content::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 5px;
        }

        .output-content::-webkit-scrollbar-thumb {
            background: #3a3a4e;
            border-radius: 5px;
        }

        .output-content::-webkit-scrollbar-thumb:hover {
            background: #4a4a5e;
        }

        .copy-btn {
            background: linear-gradient(135deg, #4a69bd 0%, #3c5a99 100%);
            color: white;
            border: 1px solid #5a7bc4;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #5a79cd 0%, #4c6aa9 100%);
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(74, 105, 189, 0.3);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            border-color: #37be70;
        }

        /* Select All button for iOS */
        .select-btn {
            background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%);
            color: white;
            border: 1px solid #9e54bd;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .select-btn:hover {
            background: linear-gradient(135deg, #9e54bd 0%, #7c4493 100%);
            transform: scale(1.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            border: 1px solid #3a4a5a;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border-color: #4a5a6a;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #4a69bd;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            color: #a0a0a0;
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #0d0d1d;
            border: 1px solid #2a2a3e;
            border-radius: 8px;
        }

        .filter-section label {
            display: block;
            margin-bottom: 5px;
            color: #a0a0a0;
            font-weight: 500;
        }

        .filter-section select,
        .filter-section input {
            width: 100%;
            padding: 8px;
            background: #1a1a2e;
            border: 1px solid #3a3a4e;
            border-radius: 5px;
            margin-bottom: 10px;
            color: #e0e0e0;
        }

        .filter-section select:focus,
        .filter-section input:focus {
            outline: none;
            border-color: #4a69bd;
            box-shadow: 0 0 5px rgba(74, 105, 189, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #a0a0a0;
        }

        .loading.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #1a1a2e;
            border-top: 3px solid #4a69bd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .error-message {
            background: linear-gradient(135deg, #c0392b 0%, #a02921 100%);
            border: 1px solid #d0493b;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* Copy feedback for iOS */
        .copy-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(39, 174, 96, 0.95);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .copy-feedback.active {
            display: block;
            animation: fadeInOut 2s;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-nav {
                padding: 10px;
            }
            
            .tab-button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Timeline Admin Tools</h1>
            <p class="subtitle">Data extraction and analysis tools for the Gipsy Hill timeline</p>
        </div>

        <div class="error-message" id="error-message"></div>

        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-number">-</div>
                <div class="stat-label">Loading...</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="adminTools.switchTab('export', event)">📤 Export Data</button>
            <button class="tab-button" onclick="adminTools.switchTab('editor', event)">✏️ Entry Editor</button>
            <button class="tab-button" onclick="adminTools.switchTab('llm', event)">🤖 LLM Tools</button>
            <button class="tab-button" onclick="adminTools.switchTab('analysis', event)">📈 Analysis</button>
            <button class="tab-button" onclick="adminTools.switchTab('quality', event)">✅ Quality Control</button>
            <button class="tab-button" onclick="adminTools.switchTab('research', event)">🔍 Research</button>
        </div>

        <!-- Export Data Tab -->
        <div class="tab-content active" id="export-tab">
            <div class="tools-grid">
                <div class="tool-card">
                    <h2>📅 Timeline Data Export</h2>
                    <p class="tool-description">Export all timeline entries in various formats for analysis or backup.</p>
                    <button class="btn" onclick="adminTools.extractTimeline('json')">Export as JSON</button>
                    <button class="btn btn-secondary" onclick="adminTools.extractTimeline('csv')">Export as CSV</button>
                    <button class="btn btn-success" onclick="adminTools.extractTimeline('markdown')">Export as Markdown</button>
                    <button class="btn btn-warning" onclick="adminTools.extractTimeline('text')">Export as Plain Text</button>
                    <button class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" onclick="adminTools.generateCompleteSummary()">📊 Complete Summary (ALL Entries)</button>
                </div>

                <div class="tool-card">
                    <h2>📚 Citations & References</h2>
                    <p class="tool-description">Export all citations with their sources, quality ratings, and linked entries.</p>
                    <button class="btn" onclick="adminTools.extractCitations('full')">Full Citations Report</button>
                    <button class="btn btn-secondary" onclick="adminTools.extractCitations('unverified')">Unverified Only</button>
                    <button class="btn btn-success" onclick="adminTools.extractCitations('bibliography')">Bibliography Format</button>
                    <button class="btn btn-warning" onclick="adminTools.extractCitations('urls')">URLs List</button>
                </div>
            </div>
        </div>

        <!-- Entry Editor Tab -->
        <div class="tab-content" id="editor-tab">
            <div class="tools-grid">
                <div class="tool-card" style="grid-column: span 2;">
                    <h2>📝 Timeline Entry Editor</h2>
                    <p class="tool-description">Search, edit, and submit changes to timeline entries via GitHub PR</p>
                    
                    <!-- Entry Search -->
                    <div style="margin-bottom: 20px;">
                        <label for="entry-search" style="display: block; margin-bottom: 5px;">Search Entries:</label>
                        <input type="text" id="entry-search" placeholder="Type to search by title or date (or leave empty for all)..." 
                               style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;"
                               oninput="adminTools.searchEntries(this.value)"
                               onfocus="if(this.value === '') adminTools.searchEntries('')">
                        
                        <select id="entry-selector" size="8" 
                                style="width: 100%; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;"
                                onchange="adminTools.loadEntry(this.value)">
                            <option value="">-- Select an entry to edit --</option>
                        </select>
                    </div>
                    
                    <!-- Entry Form -->
                    <div id="entry-form" style="display: none;">
                        <h3 style="color: #f0f0f0; margin-bottom: 15px;">Edit Entry</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px;">Date:</label>
                                <input type="text" id="edit-date" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;">
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px;">Category:</label>
                                <select id="edit-category" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;">
                                    <option value="Culture">Culture</option>
                                    <option value="Civic">Civic</option>
                                    <option value="Community">Community</option>
                                    <option value="Development">Development</option>
                                    <option value="Education">Education</option>
                                    <option value="Gypsies">Gypsies</option>
                                    <option value="Heritage">Heritage</option>
                                    <option value="Historical">Historical</option>
                                    <option value="Infrastructure">Infrastructure</option>
                                    <option value="Nature">Nature</option>
                                    <option value="Railway">Railway</option>
                                    <option value="Religious">Religious</option>
                                    <option value="Wartime">Wartime</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px;">Importance:</label>
                                <select id="edit-importance" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;">
                                    <option value="major">Major</option>
                                    <option value="minor">Minor</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px;">Icon:</label>
                                <select id="edit-icon" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;">
                                    <option value="">No icon</option>
                                    <option value="generic">Generic</option>
                                    <option value="alert">Alert</option>
                                    <option value="apartment">Apartment</option>
                                    <option value="bomb">Bomb</option>
                                    <option value="bookmark">Bookmark</option>
                                    <option value="building">Building</option>
                                    <option value="bunker">Bunker</option>
                                    <option value="bus">Bus</option>
                                    <option value="car-explosion">Car Explosion</option>
                                    <option value="castle">Castle</option>
                                    <option value="church">Church</option>
                                    <option value="cloud">Cloud</option>
                                    <option value="cow">Cow</option>
                                    <option value="crown">Crown</option>
                                    <option value="death">Death</option>
                                    <option value="factory">Factory</option>
                                    <option value="fire">Fire</option>
                                    <option value="heart">Heart</option>
                                    <option value="hill">Hill</option>
                                    <option value="home">Home</option>
                                    <option value="house">House</option>
                                    <option value="location">Location</option>
                                    <option value="moon">Moon</option>
                                    <option value="official">Official</option>
                                    <option value="poi">Point of Interest</option>
                                    <option value="police">Police</option>
                                    <option value="quill">Quill</option>
                                    <option value="river">River</option>
                                    <option value="road">Road</option>
                                    <option value="roman">Roman</option>
                                    <option value="saxon-helmet">Saxon Helmet</option>
                                    <option value="school">School</option>
                                    <option value="shield">Shield</option>
                                    <option value="stink">Stink</option>
                                    <option value="sun">Sun</option>
                                    <option value="target">Target</option>
                                    <option value="theater">Theater</option>
                                    <option value="tools">Tools</option>
                                    <option value="train">Train</option>
                                    <option value="train-crash">Train Crash</option>
                                    <option value="tree">Tree</option>
                                    <option value="war">War</option>
                                    <option value="warning">Warning</option>
                                    <option value="water">Water</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Title:</label>
                            <input type="text" id="edit-title" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;">
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Description:</label>
                            <textarea id="edit-description" rows="6" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0; font-family: inherit;"></textarea>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Citations (comma-separated numbers):</label>
                            <input type="text" id="edit-citations" placeholder="e.g., 1, 5, 12" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;">
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Image Path:</label>
                            <input type="text" id="edit-image" placeholder="e.g., images/example.jpg" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;">
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Image Caption:</label>
                            <input type="text" id="edit-image-caption" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;">
                        </div>
                        
                        <!-- GitHub Submission -->
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #3a3a4e;">
                            <h3 style="color: #f0f0f0; margin-bottom: 15px;">Submit Changes</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">
                                    Commit Message: <span style="color: #e74c3c;">*</span>
                                    <span style="font-size: 0.8rem; color: #a0a0a0;">(Required)</span>
                                </label>
                                <input type="text" id="commit-message" 
                                       placeholder="e.g., Update Crystal Palace entry with new citation" 
                                       style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 2px solid #3a3a4e; border-radius: 5px; color: #f0f0f0;"
                                       required>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">
                                    PR Description: <span style="color: #e74c3c;">*</span>
                                    <span style="font-size: 0.8rem; color: #a0a0a0;">(Required - will be auto-filled with changes)</span>
                                </label>
                                <textarea id="pr-description" rows="6" 
                                          placeholder="This will be auto-populated with your changes. You can edit it if needed." 
                                          style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 2px solid #3a3a4e; border-radius: 5px; color: #f0f0f0; font-family: inherit;"
                                          required></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="adminTools.previewChanges()">Preview Changes</button>
                                <button class="btn" onclick="adminTools.createPR()">Create Pull Request</button>
                                <button class="btn btn-secondary" onclick="adminTools.resetForm()">Reset Form</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add New Entry Button -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #3a3a4e;">
                        <button class="btn" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);" onclick="adminTools.newEntry()">
                            ➕ Create New Entry
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLM Tools Tab -->
        <div class="tab-content" id="llm-tab">
            <div class="tools-grid">
                <div class="tool-card">
                    <h2>🤖 Verification Prompts</h2>
                    <p class="tool-description">Generate prompts for AI to verify historical accuracy.</p>
                    <div class="filter-section">
                        <label for="category-filter">Category Filter:</label>
                        <select id="category-filter">
                            <option value="all">All Categories</option>
                            <option value="Culture">Culture</option>
                            <option value="Civic">Civic</option>
                            <option value="Community">Community</option>
                            <option value="Development">Development</option>
                            <option value="Education">Education</option>
                            <option value="Gypsies">Gypsies</option>
                            <option value="Heritage">Heritage</option>
                            <option value="Historical">Historical</option>
                            <option value="Infrastructure">Infrastructure</option>
                            <option value="Nature">Nature</option>
                            <option value="Railway">Railway</option>
                            <option value="Religious">Religious</option>
                            <option value="Wartime">Wartime</option>
                        </select>
                        <label for="date-range">Date Range:</label>
                        <input type="text" id="date-range" placeholder="e.g., 1850-1900">
                    </div>
                    <button class="btn" onclick="adminTools.generateVerificationPrompt()">Generate Verification Prompt</button>
                    <button class="btn btn-secondary" onclick="adminTools.generateDiscoveryPrompt()">Find Missing Events</button>
                    <button class="btn btn-success" onclick="adminTools.generateSourcePrompt()">Source Verification</button>
                </div>

                <div class="tool-card">
                    <h2>🖼️ Image Research Prompt</h2>
                    <p class="tool-description">Generate LLM prompts to find historical images for entries.</p>
                    <button class="btn" onclick="adminTools.generateImageSearchPrompt()">Generate Image Search Query</button>
                    <button class="btn btn-secondary" onclick="adminTools.analyzeTimeline('images')">List Missing Images</button>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div class="tab-content" id="analysis-tab">
            <div class="tools-grid">
                <div class="tool-card">
                    <h2>📈 Timeline Analysis</h2>
                    <p class="tool-description">Analyze timeline data for patterns, gaps, and insights.</p>
                    <button class="btn" onclick="adminTools.analyzeTimeline('gaps')">Find Time Gaps</button>
                    <button class="btn btn-secondary" onclick="adminTools.analyzeTimeline('categories')">Category Analysis</button>
                    <button class="btn btn-success" onclick="adminTools.analyzeTimeline('quality')">Quality Report</button>
                    <button class="btn btn-warning" onclick="adminTools.generateCrossReference()">Cross-Reference Check</button>
                </div>

                <div class="tool-card">
                    <h2>🔍 Research Assistant</h2>
                    <p class="tool-description">Generate focused research queries for specific topics.</p>
                    <div class="filter-section">
                        <label for="research-topic">Research Topic:</label>
                        <input type="text" id="research-topic" placeholder="e.g., Victorian railways, Crystal Palace">
                    </div>
                    <button class="btn" onclick="adminTools.generateResearchPrompt()">Generate Research Query</button>
                    <button class="btn btn-secondary" onclick="adminTools.generateArchiveSearch()">Archive Search Terms</button>
                </div>
            </div>
        </div>

        <!-- Quality Control Tab -->
        <div class="tab-content" id="quality-tab">
            <div class="tools-grid">
                <div class="tool-card">
                    <h2>🔧 Data Validation</h2>
                    <p class="tool-description">Check data integrity and find issues.</p>
                    <button class="btn" onclick="adminTools.findDuplicates()">Find Duplicates</button>
                    <button class="btn btn-secondary" onclick="adminTools.checkDuplicateURLs()">Duplicate URLs</button>
                    <button class="btn btn-success" onclick="adminTools.validateDates()">Validate Dates</button>
                    <button class="btn btn-warning" onclick="adminTools.checkLinks()">Check All Links</button>
                </div>

                <div class="tool-card">
                    <h2>📋 Citation Management</h2>
                    <p class="tool-description">Manage and optimize citations.</p>
                    <button class="btn" onclick="adminTools.orphanedCitationsEnhanced()">Smart Orphan Analysis</button>
                    <button class="btn btn-secondary" onclick="adminTools.orphanedCitations()">Basic Orphan Check</button>
                    <button class="btn btn-success" onclick="adminTools.suggestCitationMerges()">Suggest Merges</button>
                </div>
            </div>
        </div>

        <!-- Research Tab -->
        <div class="tab-content" id="research-tab">
            <div class="tools-grid">
                <div class="tool-card">
                    <h2>📚 Archive Research</h2>
                    <p class="tool-description">Generate archive search strategies.</p>
                    <div class="filter-section">
                        <label for="research-topic-2">Research Topic:</label>
                        <input type="text" id="research-topic-2" placeholder="e.g., Victorian railways, Crystal Palace">
                    </div>
                    <button class="btn" onclick="adminTools.generateArchiveSearch()">Generate Search Strategy</button>
                    <button class="btn btn-secondary" onclick="adminTools.generateNewspaperSearch()">Newspaper Search</button>
                    <button class="btn btn-success" onclick="adminTools.generateMapSearch()">Map & Visual Search</button>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>

        <div class="output-section" id="output">
            <div class="output-header">
                <h3 class="output-title" id="output-title">Output</h3>
                <div class="output-actions">
                    <button class="select-btn" onclick="adminTools.selectAll()">🔤 Select All</button>
                    <button class="copy-btn" onclick="adminTools.copyToClipboard()">📋 Copy</button>
                </div>
            </div>
            <div class="output-content" id="output-content">
                <!-- Output will be displayed here -->
            </div>
        </div>

        <!-- Copy feedback overlay -->
        <div class="copy-feedback" id="copy-feedback">✓ Copied to Clipboard!</div>
    </div>

    <script src="timeline-data.js"></script>
    <script>
        // Create namespace for admin tools
        window.adminTools = {
            // Check if data is loaded
            dataLoaded: false,
            
            // Initialize
            init: function() {
                // Check if timeline data is available
                if (typeof window.timelineData === 'undefined' || typeof window.timelineCitations === 'undefined') {
                    this.showError('Timeline data not loaded. Please ensure timeline-data.js is properly loaded.');
                    return false;
                }
                
                // Check if categories are defined
                if (typeof window.timelineCategories === 'undefined') {
                    // Define a fallback
                    window.timelineCategories = {
                        "Culture": { "name": "Culture" },
                        "Civic": { "name": "Civic" },
                        "Community": { "name": "Community" },
                        "Development": { "name": "Development" },
                        "Education": { "name": "Education" },
                        "Gypsies": { "name": "Gypsies" },
                        "Heritage": { "name": "Heritage" },
                        "Historical": { "name": "Historical" },
                        "Infrastructure": { "name": "Infrastructure" },
                        "Nature": { "name": "Nature" },
                        "Railway": { "name": "Railway" },
                        "Religious": { "name": "Religious" },
                        "Wartime": { "name": "Wartime" }
                    };
                }
                
                this.dataLoaded = true;
                this.updateStats();
                return true;
            },

            switchTab: function(tabName, event) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Remove active from all buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show selected tab
                const selectedTab = document.getElementById(tabName + '-tab');
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }
                
                // Mark button as active
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // If switching to editor tab, populate the entry list
                if (tabName === 'editor' && this.dataLoaded) {
                    // Trigger initial population of entries
                    const searchInput = document.getElementById('entry-search');
                    if (searchInput && searchInput.value === '') {
                        this.searchEntries('');
                    }
                }
            },

            showError: function(message) {
                const errorEl = document.getElementById('error-message');
                if (errorEl) {
                    errorEl.textContent = '⚠️ ' + message;
                    errorEl.classList.add('active');
                    setTimeout(() => {
                        errorEl.classList.remove('active');
                    }, 5000);
                }
            },

            updateStats: function() {
                if (!this.dataLoaded) return;
                
                const stats = {
                    'Total Entries': window.timelineData.length,
                    'Total Citations': window.timelineCitations.length,
                    'Verified': window.timelineCitations.filter(c => c.status === 'Verified').length,
                    'Categories': Object.keys(window.timelineCategories).length,
                    'With Images': window.timelineData.filter(e => e.image).length,
                    'Major Events': window.timelineData.filter(e => e.importance === 'major').length
                };

                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = '';
                
                for (const [label, value] of Object.entries(stats)) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-number">${value}</div>
                        <div class="stat-label">${label}</div>
                    `;
                    statsGrid.appendChild(card);
                }
            },

            showOutput: function(title, content) {
                document.getElementById('output-title').textContent = title;
                document.getElementById('output-content').textContent = content;
                document.getElementById('output').classList.add('active');
                document.getElementById('loading').classList.remove('active');
                
                // Scroll to output
                document.getElementById('output').scrollIntoView({ behavior: 'smooth', block: 'start' });
            },

            showLoading: function() {
                document.getElementById('loading').classList.add('active');
            },

            // iOS-friendly select all
            selectAll: function() {
                const content = document.getElementById('output-content');
                if (window.getSelection) {
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(content);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            },

            // Improved clipboard functionality for iOS
            copyToClipboard: function() {
                const content = document.getElementById('output-content').textContent;
                
                // Try multiple methods for better iOS compatibility
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    // Modern API
                    navigator.clipboard.writeText(content).then(() => {
                        this.showCopyFeedback();
                    }).catch(() => {
                        this.fallbackCopy(content);
                    });
                } else {
                    this.fallbackCopy(content);
                }
            },

            fallbackCopy: function(text) {
                // Create temporary textarea
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.top = '0';
                textarea.style.left = '0';
                textarea.style.width = '2em';
                textarea.style.height = '2em';
                textarea.style.padding = '0';
                textarea.style.border = 'none';
                textarea.style.outline = 'none';
                textarea.style.boxShadow = 'none';
                textarea.style.background = 'transparent';
                
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                // For iOS
                textarea.setSelectionRange(0, textarea.value.length);
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showCopyFeedback();
                    } else {
                        this.showError('Copy failed. Please select and copy manually.');
                    }
                } catch (err) {
                    this.showError('Copy failed. Please select and copy manually.');
                }
                
                document.body.removeChild(textarea);
            },

            showCopyFeedback: function() {
                const feedback = document.getElementById('copy-feedback');
                feedback.classList.add('active');
                
                // Button feedback
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '✓ Copied!';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    feedback.classList.remove('active');
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            },

            extractTimeline: function(format) {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = '';
                    
                    switch(format) {
                        case 'json':
                            output = JSON.stringify(window.timelineData, null, 2);
                            this.showOutput('Timeline Data (JSON)', output);
                            break;
                        
                        case 'csv':
                            output = 'Date,Title,Description,Category,Importance,Citations,Image\n';
                            window.timelineData.forEach(entry => {
                                const citations = entry.citations ? entry.citations.join(';') : '';
                                const row = [
                                    `"${entry.date}"`,
                                    `"${entry.title}"`,
                                    `"${(entry.description || '').replace(/"/g, '""')}"`,
                                    entry.category || '',
                                    entry.importance || '',
                                    citations,
                                    entry.image || ''
                                ].join(',');
                                output += row + '\n';
                            });
                            this.showOutput('Timeline Data (CSV)', output);
                            break;
                        
                        case 'markdown':
                            output = '# Gipsy Hill Timeline\n\n';
                            window.timelineData.forEach(entry => {
                                output += `## ${entry.date} - ${entry.title}\n\n`;
                                output += `**Category:** ${entry.category || 'N/A'} | **Importance:** ${entry.importance || 'N/A'}\n\n`;
                                output += `${entry.description || 'No description'}\n\n`;
                                if (entry.citations && entry.citations.length > 0) {
                                    output += `**Citations:** ${entry.citations.join(', ')}\n\n`;
                                }
                                if (entry.image) {
                                    output += `**Image:** ${entry.image}\n\n`;
                                }
                                output += '---\n\n';
                            });
                            this.showOutput('Timeline Data (Markdown)', output);
                            break;
                        
                        case 'text':
                            output = 'GIPSY HILL TIMELINE\n';
                            output += '=' .repeat(50) + '\n\n';
                            window.timelineData.forEach(entry => {
                                output += `${entry.date} - ${entry.title}\n`;
                                output += '-'.repeat(40) + '\n';
                                output += `Category: ${entry.category || 'N/A'} | Importance: ${entry.importance || 'N/A'}\n\n`;
                                output += `${entry.description || 'No description'}\n\n`;
                                if (entry.citations && entry.citations.length > 0) {
                                    output += `Citations: ${entry.citations.join(', ')}\n`;
                                }
                                output += '\n' + '='.repeat(50) + '\n\n';
                            });
                            this.showOutput('Timeline Data (Plain Text)', output);
                            break;
                    }
                }, 100);
            },

            generateCompleteSummary: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'COMPLETE TIMELINE SUMMARY - ALL ENTRIES\n';
                    output += '=' .repeat(70) + '\n';
                    output += `Total Entries: ${window.timelineData.length}\n`;
                    output += `Generated: ${new Date().toLocaleString()}\n`;
                    output += '=' .repeat(70) + '\n\n';
                    
                    // Sort entries by date
                    const sortedEntries = [...window.timelineData].sort((a, b) => {
                        const yearA = parseInt(a.date.match(/\d{4}/)?.[0] || '0');
                        const yearB = parseInt(b.date.match(/\d{4}/)?.[0] || '0');
                        return yearA - yearB;
                    });
                    
                    // Group by category for summary stats
                    const categoryStats = {};
                    sortedEntries.forEach(e => {
                        const cat = e.category || 'uncategorized';
                        categoryStats[cat] = (categoryStats[cat] || 0) + 1;
                    });
                    
                    output += 'CATEGORY BREAKDOWN:\n';
                    output += '-'.repeat(30) + '\n';
                    Object.entries(categoryStats)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([cat, count]) => {
                            output += `${cat}: ${count} entries\n`;
                        });
                    output += '\n' + '=' .repeat(70) + '\n\n';
                    
                    output += 'ALL TIMELINE ENTRIES (Chronological Order):\n';
                    output += '=' .repeat(70) + '\n\n';
                    
                    // Counter to verify we include all entries
                    let entryCount = 0;
                    
                    sortedEntries.forEach((entry, index) => {
                        entryCount++;
                        output += `${entryCount}. ${entry.date} - ${entry.title} [${entry.category || 'uncategorized'}]\n`;
                    });
                    
                    output += '=' .repeat(70) + '\n';
                    output += `END OF REPORT - TOTAL ENTRIES INCLUDED: ${entryCount} of ${window.timelineData.length}\n`;
                    
                    if (entryCount !== window.timelineData.length) {
                        output += `\n⚠️ WARNING: Entry count mismatch! Expected ${window.timelineData.length} but processed ${entryCount}\n`;
                    } else {
                        output += '\n✅ All entries successfully included in report\n';
                    }
                    
                    this.showOutput('Complete Timeline Summary', output);
                }, 100);
            },

            extractCitations: function(type) {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = '';
                    
                    switch(type) {
                        case 'full':
                            output = 'FULL CITATIONS REPORT\n';
                            output += '=' .repeat(50) + '\n\n';
                            window.timelineCitations.forEach(cit => {
                                output += `[${cit.number}] ${cit.timeline_entry}\n`;
                                output += `Status: ${cit.status} | Quality: ${cit.quality || 'N/A'}\n`;
                                output += `Source: ${cit.source}\n`;
                                if (cit.url) {
                                    output += `URL: ${cit.url}\n`;
                                }
                                if (cit.additional_urls && cit.additional_urls.length > 0) {
                                    output += `Additional URLs:\n`;
                                    cit.additional_urls.forEach(url => {
                                        output += `  - ${url}\n`;
                                    });
                                }
                                // Find which entries use this citation
                                const usedIn = window.timelineData.filter(e => 
                                    e.citations && e.citations.includes(cit.number)
                                );
                                if (usedIn.length > 0) {
                                    output += `Used in entries:\n`;
                                    usedIn.forEach(entry => {
                                        output += `  - ${entry.date}: ${entry.title}\n`;
                                    });
                                }
                                output += '\n' + '-'.repeat(50) + '\n\n';
                            });
                            this.showOutput('Full Citations Report', output);
                            break;
                        
                        case 'unverified':
                            const unverified = window.timelineCitations.filter(c => 
                                c.status === 'Unverified' || c.status === 'Partially verified'
                            );
                            output = `UNVERIFIED CITATIONS (${unverified.length} total)\n`;
                            output += '=' .repeat(50) + '\n\n';
                            unverified.forEach(cit => {
                                output += `[${cit.number}] ${cit.timeline_entry}\n`;
                                output += `Status: ${cit.status}\n`;
                                output += `Source: ${cit.source}\n`;
                                output += `Needs: Additional verification and primary sources\n\n`;
                            });
                            this.showOutput('Unverified Citations', output);
                            break;
                        
                        case 'bibliography':
                            output = 'BIBLIOGRAPHY\n';
                            output += '=' .repeat(50) + '\n\n';
                            const sorted = [...window.timelineCitations].sort((a, b) => 
                                (a.timeline_entry || '').localeCompare(b.timeline_entry || '')
                            );
                            sorted.forEach(cit => {
                                output += `${cit.timeline_entry}. ${cit.source}`;
                                if (cit.url) {
                                    output += ` Available at: ${cit.url}`;
                                }
                                output += `\n\n`;
                            });
                            this.showOutput('Bibliography', output);
                            break;
                        
                        case 'urls':
                            output = 'ALL CITATION URLS\n';
                            output += '=' .repeat(50) + '\n\n';
                            window.timelineCitations.forEach(cit => {
                                if (cit.url) {
                                    output += `[${cit.number}] ${cit.url}\n`;
                                }
                                if (cit.additional_urls && cit.additional_urls.length > 0) {
                                    cit.additional_urls.forEach(url => {
                                        output += `[${cit.number}] ${url}\n`;
                                    });
                                }
                            });
                            this.showOutput('Citation URLs', output);
                            break;
                    }
                }, 100);
            },

            generateVerificationPrompt: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    const category = document.getElementById('category-filter').value;
                    const dateRange = document.getElementById('date-range').value;
                    
                    let entries = window.timelineData;
                    if (category !== 'all') {
                        entries = entries.filter(e => e.category === category);
                    }
                    if (dateRange) {
                        // Simple date range filter
                        const rangeParts = dateRange.split('-');
                        if (rangeParts.length > 0) {
                            entries = entries.filter(e => {
                                const year = e.date.match(/\d{4}/);
                                if (year) {
                                    const yearNum = parseInt(year[0]);
                                    const startYear = parseInt(rangeParts[0]);
                                    const endYear = rangeParts[1] ? parseInt(rangeParts[1]) : startYear;
                                    return yearNum >= startYear && yearNum <= endYear;
                                }
                                return false;
                            });
                        }
                    }
                    
                    let prompt = `Please verify the historical accuracy of the following timeline entries for Gipsy Hill in South London. For each entry, confirm or correct the dates, check the factual accuracy, and suggest any additional relevant details or context that might be missing.\n\n`;
                    prompt += `Focus Area: ${category === 'all' ? 'All categories' : category}\n`;
                    if (dateRange) prompt += `Date Range: ${dateRange}\n`;
                    prompt += `\nTIMELINE ENTRIES TO VERIFY:\n\n`;
                    
                    entries.forEach(entry => {
                        prompt += `${entry.date} - ${entry.title}\n`;
                        prompt += `Description: ${entry.description}\n`;
                        prompt += `Current Citations: ${entry.citations ? entry.citations.join(', ') : 'None'}\n`;
                        prompt += `Verification needed for:\n`;
                        prompt += `- Date accuracy\n`;
                        prompt += `- Factual correctness\n`;
                        prompt += `- Missing context or details\n`;
                        prompt += `- Additional primary sources\n\n`;
                    });
                    
                    prompt += `\nPlease provide:\n`;
                    prompt += `1. Confirmation or correction of dates\n`;
                    prompt += `2. Any factual errors found\n`;
                    prompt += `3. Additional historical context\n`;
                    prompt += `4. Suggested primary sources or references\n`;
                    prompt += `5. Related events that might be missing from this timeline`;
                    
                    this.showOutput('LLM Verification Prompt', prompt);
                }, 100);
            },

            generateDiscoveryPrompt: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    const category = document.getElementById('category-filter').value;
                    const dateRange = document.getElementById('date-range').value;
                    
                    let prompt = `I'm researching the history of Gipsy Hill in South London. Below is our current timeline of events. Please identify significant historical events, developments, or people that are MISSING from this timeline.\n\n`;
                    
                    if (category !== 'all') {
                        prompt += `Focus particularly on events related to: ${category}\n`;
                    }
                    if (dateRange) {
                        prompt += `Time period of interest: ${dateRange}\n`;
                    }
                    
                    prompt += `\nCURRENT TIMELINE COVERAGE:\n\n`;
                    
                    // Group by decade for summary
                    const decades = {};
                    window.timelineData.forEach(entry => {
                        const year = entry.date.match(/\d{4}/);
                        if (year) {
                            const decade = Math.floor(year[0] / 10) * 10;
                            if (!decades[decade]) decades[decade] = [];
                            decades[decade].push(entry.title);
                        }
                    });
                    
                    Object.keys(decades).sort().forEach(decade => {
                        prompt += `${decade}s: ${decades[decade].length} events\n`;
                        decades[decade].forEach(title => {
                            prompt += `  - ${title}\n`;
                        });
                    });
                    
                    prompt += `\nPlease suggest:\n`;
                    prompt += `1. Major historical events we've missed\n`;
                    prompt += `2. Important local figures not mentioned\n`;
                    prompt += `3. Significant buildings or landmarks not covered\n`;
                    prompt += `4. Social/cultural developments overlooked\n`;
                    prompt += `5. Economic or industrial changes not documented\n`;
                    prompt += `6. Transportation developments beyond what's listed\n`;
                    prompt += `7. Wartime events or impacts not included\n`;
                    prompt += `8. Environmental or urban planning changes\n\n`;
                    prompt += `For each suggestion, please provide:\n`;
                    prompt += `- Specific date or date range\n`;
                    prompt += `- Brief description\n`;
                    prompt += `- Why it's historically significant\n`;
                    prompt += `- Potential sources for verification`;
                    
                    this.showOutput('Discovery Prompt for Missing Events', prompt);
                }, 100);
            },

            generateSourcePrompt: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    const unverified = window.timelineCitations.filter(c => 
                        c.status === 'Unverified' || c.status === 'Partially verified'
                    );
                    
                    let prompt = `Please help find primary sources and verification for the following historical claims about Gipsy Hill in South London. These entries currently lack strong verification:\n\n`;
                    
                    unverified.forEach(cit => {
                        const entries = window.timelineData.filter(e => 
                            e.citations && e.citations.includes(cit.number)
                        );
                        
                        entries.forEach(entry => {
                            prompt += `CLAIM: ${entry.date} - ${entry.title}\n`;
                            prompt += `Details: ${entry.description}\n`;
                            prompt += `Current source: ${cit.source}\n`;
                            prompt += `Status: ${cit.status}\n\n`;
                            prompt += `Please find:\n`;
                            prompt += `- Primary sources (newspapers, archives, official records)\n`;
                            prompt += `- Contemporary accounts or documents\n`;
                            prompt += `- Academic papers or books that reference this\n`;
                            prompt += `- Museum or library collections with evidence\n`;
                            prompt += `- Maps, photographs, or other visual evidence\n\n`;
                        });
                    });
                    
                    prompt += `For each claim, please provide:\n`;
                    prompt += `1. Specific archive references (with catalog numbers if possible)\n`;
                    prompt += `2. Newspaper citations (publication, date, page)\n`;
                    prompt += `3. Book references (author, title, year, page numbers)\n`;
                    prompt += `4. Online database entries\n`;
                    prompt += `5. Confidence level in the claim's accuracy`;
                    
                    this.showOutput('Source Verification Prompt', prompt);
                }, 100);
            },

            // New enhanced image search prompt generator
            generateImageSearchPrompt: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    const withoutImages = window.timelineData.filter(e => !e.image);
                    const majorWithoutImages = withoutImages.filter(e => e.importance === 'major');
                    
                    let prompt = `I need help finding historical images for timeline entries about Gipsy Hill in South London. Please search for photographs, illustrations, maps, or other visual materials for the following events.\n\n`;
                    
                    prompt += `PRIORITY ENTRIES (Major events without images):\n`;
                    prompt += `${'='.repeat(50)}\n\n`;
                    
                    majorWithoutImages.forEach(entry => {
                        prompt += `DATE: ${entry.date}\n`;
                        prompt += `EVENT: ${entry.title}\n`;
                        prompt += `DETAILS: ${entry.description}\n`;
                        prompt += `CATEGORY: ${entry.category}\n\n`;
                        prompt += `Search suggestions:\n`;
                        prompt += `- Archive photographs from this period\n`;
                        prompt += `- Contemporary illustrations or engravings\n`;
                        prompt += `- Maps showing the location\n`;
                        prompt += `- Similar buildings or events from the same era\n`;
                        prompt += `- Local history collections\n\n`;
                        prompt += `-`.repeat(40) + `\n\n`;
                    });
                    
                    prompt += `\nOTHER ENTRIES NEEDING IMAGES:\n`;
                    prompt += `${'='.repeat(50)}\n\n`;
                    
                    withoutImages.filter(e => e.importance !== 'major').forEach(entry => {
                        prompt += `- ${entry.date}: ${entry.title}\n`;
                    });
                    
                    prompt += `\n\nRECOMMENDED SOURCES TO SEARCH:\n`;
                    prompt += `1. Lambeth Archives - photographic collection\n`;
                    prompt += `2. London Metropolitan Archives\n`;
                    prompt += `3. Historic England Archive\n`;
                    prompt += `4. British Library image collections\n`;
                    prompt += `5. National Archives photographic holdings\n`;
                    prompt += `6. Local history society collections\n`;
                    prompt += `7. Ordnance Survey historical maps\n`;
                    prompt += `8. Borough Photos website\n`;
                    prompt += `9. London Picture Archive\n`;
                    prompt += `10. Wikimedia Commons historical images\n\n`;
                    
                    prompt += `For each image found, please provide:\n`;
                    prompt += `- Direct URL or archive reference\n`;
                    prompt += `- Date of image\n`;
                    prompt += `- Copyright status\n`;
                    prompt += `- Brief description\n`;
                    prompt += `- Attribution requirements`;
                    
                    this.showOutput('Image Search LLM Prompt', prompt);
                }, 100);
            },

            analyzeTimeline: function(type) {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = '';
                    
                    switch(type) {
                        case 'gaps':
                            output = 'TIMELINE GAP ANALYSIS\n';
                            output += '=' .repeat(50) + '\n\n';
                            
                            // Extract years and sort
                            const years = window.timelineData
                                .map(e => {
                                    const match = e.date.match(/\d{4}/);
                                    return match ? parseInt(match[0]) : null;
                                })
                                .filter(y => y !== null)
                                .sort((a, b) => a - b);
                            
                            let gaps = [];
                            for (let i = 1; i < years.length; i++) {
                                const gap = years[i] - years[i-1];
                                if (gap > 10) {
                                    gaps.push({
                                        start: years[i-1],
                                        end: years[i],
                                        gap: gap
                                    });
                                }
                            }
                            
                            output += `Found ${gaps.length} significant gaps (>10 years):\n\n`;
                            gaps.forEach(g => {
                                output += `${g.start} to ${g.end}: ${g.gap} year gap\n`;
                                output += `  Consider researching events from this period\n\n`;
                            });
                            
                            // Analyze by century
                            output += '\nENTRIES BY CENTURY:\n';
                            const centuries = {};
                            years.forEach(y => {
                                const century = Math.floor(y / 100) * 100;
                                centuries[century] = (centuries[century] || 0) + 1;
                            });
                            Object.keys(centuries).sort().forEach(c => {
                                output += `${c}s: ${centuries[c]} entries\n`;
                            });
                            
                            this.showOutput('Timeline Gap Analysis', output);
                            break;
                        
                        case 'categories':
                            output = 'CATEGORY ANALYSIS\n';
                            output += '=' .repeat(50) + '\n\n';
                            
                            const catCount = {};
                            window.timelineData.forEach(e => {
                                const cat = e.category || 'uncategorized';
                                catCount[cat] = (catCount[cat] || 0) + 1;
                            });
                            
                            Object.entries(catCount)
                                .sort((a, b) => b[1] - a[1])
                                .forEach(([cat, count]) => {
                                    const pct = ((count / window.timelineData.length) * 100).toFixed(1);
                                    output += `${cat}: ${count} entries (${pct}%)\n`;
                                    output += '-'.repeat(40) + '\n';
                                    
                                    // List ALL entries in this category
                                    const entries = window.timelineData
                                        .filter(e => (e.category || 'uncategorized') === cat)
                                        .sort((a, b) => {
                                            // Sort by date
                                            const yearA = parseInt(a.date.match(/\d{4}/)?.[0] || '0');
                                            const yearB = parseInt(b.date.match(/\d{4}/)?.[0] || '0');
                                            return yearA - yearB;
                                        });
                                    entries.forEach(e => {
                                        output += `  - ${e.date}: ${e.title}\n`;
                                    });
                                    output += '\n';
                                });
                            
                            this.showOutput('Category Analysis', output);
                            break;
                        
                        case 'quality':
                            output = 'QUALITY REPORT\n';
                            output += '=' .repeat(50) + '\n\n';
                            
                            // Citation quality
                            const qualityCount = {};
                            window.timelineCitations.forEach(c => {
                                const q = c.quality || 'Not rated';
                                qualityCount[q] = (qualityCount[q] || 0) + 1;
                            });
                            
                            output += 'CITATION QUALITY:\n';
                            Object.entries(qualityCount).forEach(([quality, count]) => {
                                output += `${quality}: ${count} citations\n`;
                            });
                            
                            // Verification status
                            output += '\n\nVERIFICATION STATUS:\n';
                            const statusCount = {};
                            window.timelineCitations.forEach(c => {
                                statusCount[c.status] = (statusCount[c.status] || 0) + 1;
                            });
                            Object.entries(statusCount).forEach(([status, count]) => {
                                output += `${status}: ${count} citations\n`;
                            });
                            
                            // Entries without citations
                            output += '\n\nENTRIES WITHOUT CITATIONS:\n';
                            const noCitations = window.timelineData.filter(e => !e.citations || e.citations.length === 0);
                            output += `${noCitations.length} entries lack citations:\n`;
                            noCitations.forEach(e => {
                                output += `  - ${e.date}: ${e.title}\n`;
                            });
                            if (noCitations.length > 10) {
                                output += `  ... and ${noCitations.length - 10} more\n`;
                            }
                            
                            this.showOutput('Quality Report', output);
                            break;
                        
                        case 'images':
                            output = 'IMAGE ANALYSIS\n';
                            output += '=' .repeat(50) + '\n\n';
                            
                            const withImages = window.timelineData.filter(e => e.image);
                            const withoutImages = window.timelineData.filter(e => !e.image);
                            
                            output += `Total entries: ${window.timelineData.length}\n`;
                            output += `With images: ${withImages.length} (${((withImages.length/window.timelineData.length)*100).toFixed(1)}%)\n`;
                            output += `Without images: ${withoutImages.length} (${((withoutImages.length/window.timelineData.length)*100).toFixed(1)}%)\n\n`;
                            
                            output += 'ENTRIES MISSING IMAGES:\n';
                            output += '(Priority: Major events without images)\n\n';
                            
                            const majorWithoutImages = withoutImages.filter(e => e.importance === 'major');
                            majorWithoutImages.forEach(e => {
                                output += `[MAJOR] ${e.date}: ${e.title}\n`;
                            });
                            
                            output += '\nOther entries without images:\n';
                            withoutImages
                                .filter(e => e.importance !== 'major')
                                .forEach(e => {
                                    output += `  - ${e.date}: ${e.title}\n`;
                                });
                            
                            this.showOutput('Image Analysis', output);
                            break;
                    }
                }, 100);
            },

            findDuplicates: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'DUPLICATE DETECTION REPORT\n';
                    output += '=' .repeat(50) + '\n\n';
                    
                    // Check for duplicate dates and titles
                    const dateGroups = {};
                    window.timelineData.forEach((entry, index) => {
                        if (!dateGroups[entry.date]) {
                            dateGroups[entry.date] = [];
                        }
                        dateGroups[entry.date].push({...entry, index});
                    });
                    
                    let duplicatesFound = false;
                    Object.entries(dateGroups).forEach(([date, entries]) => {
                        if (entries.length > 1) {
                            duplicatesFound = true;
                            output += `Multiple entries for ${date}:\n`;
                            entries.forEach(e => {
                                output += `  - ${e.title}\n`;
                            });
                            output += '\n';
                        }
                    });
                    
                    // Check for similar titles
                    output += 'SIMILAR TITLES (potential duplicates):\n';
                    for (let i = 0; i < window.timelineData.length; i++) {
                        for (let j = i + 1; j < window.timelineData.length; j++) {
                            const similarity = this.calculateSimilarity(
                                window.timelineData[i].title.toLowerCase(),
                                window.timelineData[j].title.toLowerCase()
                            );
                            if (similarity > 0.8) {
                                output += `Similarity ${(similarity*100).toFixed(0)}%:\n`;
                                output += `  - ${window.timelineData[i].date}: ${window.timelineData[i].title}\n`;
                                output += `  - ${window.timelineData[j].date}: ${window.timelineData[j].title}\n\n`;
                                duplicatesFound = true;
                            }
                        }
                    }
                    
                    if (!duplicatesFound) {
                        output += 'No duplicates detected!';
                    }
                    
                    this.showOutput('Duplicate Detection', output);
                }, 100);
            },

            // New function to check duplicate URLs
            checkDuplicateURLs: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'DUPLICATE URL ANALYSIS\n';
                    output += '=' .repeat(50) + '\n\n';
                    
                    const urlMap = {};
                    
                    // Collect all URLs
                    window.timelineCitations.forEach(cit => {
                        if (cit.url) {
                            if (!urlMap[cit.url]) urlMap[cit.url] = [];
                            urlMap[cit.url].push(cit.number);
                        }
                        if (cit.additional_urls) {
                            cit.additional_urls.forEach(url => {
                                if (!urlMap[url]) urlMap[url] = [];
                                urlMap[url].push(cit.number);
                            });
                        }
                    });
                    
                    // Find duplicates
                    const duplicates = Object.entries(urlMap).filter(([url, citations]) => citations.length > 1);
                    
                    if (duplicates.length === 0) {
                        output += 'No duplicate URLs found!\n';
                    } else {
                        output += `Found ${duplicates.length} URLs used in multiple citations:\n\n`;
                        
                        duplicates.forEach(([url, citations]) => {
                            output += `URL: ${url}\n`;
                            output += `Used in citations: ${citations.join(', ')}\n`;
                            
                            // Show what each citation is about
                            citations.forEach(num => {
                                const cit = window.timelineCitations.find(c => c.number === num);
                                if (cit) {
                                    output += `  [${num}] ${cit.timeline_entry}\n`;
                                }
                            });
                            output += '\n';
                        });
                        
                        output += '\nRECOMMENDATION:\n';
                        output += 'Consider consolidating citations that reference the same URL.\n';
                        output += 'This could reduce redundancy and make citation management easier.\n';
                    }
                    
                    this.showOutput('Duplicate URL Report', output);
                }, 100);
            },

            // Enhanced orphaned citations with suggestions
            orphanedCitationsEnhanced: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'SMART ORPHANED CITATIONS ANALYSIS\n';
                    output += '=' .repeat(50) + '\n\n';
                    
                    const usedCitations = new Set();
                    window.timelineData.forEach(entry => {
                        if (entry.citations) {
                            entry.citations.forEach(cit => usedCitations.add(cit));
                        }
                    });
                    
                    const orphaned = window.timelineCitations.filter(cit => 
                        !usedCitations.has(cit.number)
                    );
                    
                    if (orphaned.length === 0) {
                        output += 'No orphaned citations found! All citations are referenced.\n';
                    } else {
                        output += `Found ${orphaned.length} orphaned citations:\n\n`;
                        
                        orphaned.forEach(cit => {
                            output += `[${cit.number}] ${cit.timeline_entry}\n`;
                            output += `Status: ${cit.status}\n`;
                            output += `Source: ${cit.source}\n`;
                            
                            // Find potentially relevant entries
                            const keywords = this.extractKeywords((cit.timeline_entry + ' ' + cit.source).toLowerCase());
                            const relevantEntries = [];
                            
                            window.timelineData.forEach(entry => {
                                const entryText = (entry.title + ' ' + entry.description).toLowerCase();
                                const entryKeywords = this.extractKeywords(entryText);
                                
                                const matches = keywords.filter(k => entryKeywords.includes(k));
                                if (matches.length >= 2) {
                                    relevantEntries.push({
                                        entry: entry,
                                        matches: matches.length
                                    });
                                }
                            });
                            
                            if (relevantEntries.length > 0) {
                                output += '\nPotentially relevant entries:\n';
                                relevantEntries
                                    .sort((a, b) => b.matches - a.matches)
                                    .forEach(r => {
                                        output += `  - ${r.entry.date}: ${r.entry.title} (${r.matches} keyword matches)\n`;
                                    });
                            }
                            
                            output += '\n' + '-'.repeat(40) + '\n\n';
                        });
                        
                        output += 'RECOMMENDATION:\n';
                        output += 'Review the suggested relevant entries above.\n';
                        output += 'Either add these citations to appropriate entries or remove if no longer needed.\n';
                    }
                    
                    this.showOutput('Smart Orphaned Citations Analysis', output);
                }, 100);
            },

            orphanedCitations: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'ORPHANED CITATIONS REPORT\n';
                    output += '=' .repeat(50) + '\n\n';
                    
                    const usedCitations = new Set();
                    window.timelineData.forEach(entry => {
                        if (entry.citations) {
                            entry.citations.forEach(cit => usedCitations.add(cit));
                        }
                    });
                    
                    const orphaned = window.timelineCitations.filter(cit => 
                        !usedCitations.has(cit.number)
                    );
                    
                    if (orphaned.length === 0) {
                        output += 'No orphaned citations found! All citations are referenced.\n';
                    } else {
                        output += `Found ${orphaned.length} orphaned citations:\n\n`;
                        orphaned.forEach(cit => {
                            output += `[${cit.number}] ${cit.timeline_entry}\n`;
                            output += `Source: ${cit.source}\n\n`;
                        });
                        output += 'These citations are defined but not referenced by any timeline entry.\n';
                        output += 'Consider either:\n';
                        output += '1. Adding them to relevant timeline entries\n';
                        output += '2. Removing them if no longer needed\n';
                    }
                    
                    this.showOutput('Orphaned Citations', output);
                }, 100);
            },

            // Suggest citation merges
            suggestCitationMerges: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'CITATION MERGE SUGGESTIONS\n';
                    output += '=' .repeat(50) + '\n\n';
                    
                    const suggestions = [];
                    
                    // Check for similar sources
                    for (let i = 0; i < window.timelineCitations.length; i++) {
                        for (let j = i + 1; j < window.timelineCitations.length; j++) {
                            const cit1 = window.timelineCitations[i];
                            const cit2 = window.timelineCitations[j];
                            
                            // Check if sources are very similar
                            const similarity = this.calculateSimilarity(
                                cit1.source.toLowerCase(),
                                cit2.source.toLowerCase()
                            );
                            
                            if (similarity > 0.7) {
                                suggestions.push({
                                    cit1: cit1,
                                    cit2: cit2,
                                    similarity: similarity
                                });
                            }
                        }
                    }
                    
                    if (suggestions.length === 0) {
                        output += 'No merge suggestions found.\n';
                    } else {
                        output += `Found ${suggestions.length} potential merges:\n\n`;
                        
                        suggestions
                            .sort((a, b) => b.similarity - a.similarity)
                            .forEach(s => {
                                output += `Similarity: ${(s.similarity * 100).toFixed(0)}%\n`;
                                output += `[${s.cit1.number}] ${s.cit1.timeline_entry}\n`;
                                output += `[${s.cit2.number}] ${s.cit2.timeline_entry}\n`;
                                output += `Source 1: ${s.cit1.source}\n`;
                                output += `Source 2: ${s.cit2.source}\n`;
                                output += '\n' + '-'.repeat(40) + '\n\n';
                            });
                    }
                    
                    this.showOutput('Citation Merge Suggestions', output);
                }, 100);
            },

            calculateSimilarity: function(str1, str2) {
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;
                
                if (longer.length === 0) return 1.0;
                
                const editDistance = (s1, s2) => {
                    const costs = [];
                    for (let i = 0; i <= s1.length; i++) {
                        let lastValue = i;
                        for (let j = 0; j <= s2.length; j++) {
                            if (i === 0) {
                                costs[j] = j;
                            } else if (j > 0) {
                                let newValue = costs[j - 1];
                                if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                                }
                                costs[j - 1] = lastValue;
                                lastValue = newValue;
                            }
                        }
                        if (i > 0) costs[s2.length] = lastValue;
                    }
                    return costs[s2.length];
                };
                
                return (longer.length - editDistance(longer, shorter)) / longer.length;
            },

            checkLinks: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'LINK CHECK REPORT\n';
                    output += '=' .repeat(50) + '\n\n';
                    output += 'Note: Actual link checking would require server-side validation.\n';
                    output += 'This report lists all URLs for manual checking.\n\n';
                    
                    const urls = new Set();
                    
                    // Collect URLs from citations
                    window.timelineCitations.forEach(cit => {
                        if (cit.url) urls.add(cit.url);
                        if (cit.additional_urls) {
                            cit.additional_urls.forEach(url => urls.add(url));
                        }
                    });
                    
                    output += `Total unique URLs: ${urls.size}\n\n`;
                    output += 'ALL URLS:\n';
                    [...urls].sort().forEach(url => {
                        output += `${url}\n`;
                    });
                    
                    output += '\n\nTo check these URLs:\n';
                    output += '1. Copy this list\n';
                    output += '2. Use a link checker tool\n';
                    output += '3. Update any broken links in timeline-data.js\n';
                    
                    this.showOutput('Link Check Report', output);
                }, 100);
            },

            validateDates: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'DATE VALIDATION REPORT\n';
                    output += '=' .repeat(50) + '\n\n';
                    
                    const issues = [];
                    
                    window.timelineData.forEach((entry, index) => {
                        // Check for various date formats and potential issues
                        const date = entry.date;
                        
                        // Check for missing dates
                        if (!date) {
                            issues.push(`Entry ${index}: Missing date - ${entry.title}`);
                        }
                        
                        // Check for unusual formats
                        if (date && !date.match(/\d{4}/) && !date.match(/^\d{1,2}(st|nd|rd|th) c\./)) {
                            issues.push(`Entry ${index}: Unusual date format "${date}" - ${entry.title}`);
                        }
                        
                        // Check for future dates
                        const year = date ? date.match(/\d{4}/) : null;
                        if (year && parseInt(year[0]) > new Date().getFullYear()) {
                            issues.push(`Entry ${index}: Future date "${date}" - ${entry.title}`);
                        }
                    });
                    
                    if (issues.length === 0) {
                        output += 'All dates validated successfully!\n';
                    } else {
                        output += `Found ${issues.length} potential issues:\n\n`;
                        issues.forEach(issue => {
                            output += `${issue}\n`;
                        });
                    }
                    
                    // Date format summary
                    output += '\n\nDATE FORMAT SUMMARY:\n';
                    const formats = {};
                    window.timelineData.forEach(entry => {
                        const format = this.detectDateFormat(entry.date);
                        formats[format] = (formats[format] || 0) + 1;
                    });
                    
                    Object.entries(formats).forEach(([format, count]) => {
                        output += `${format}: ${count} entries\n`;
                    });
                    
                    this.showOutput('Date Validation', output);
                }, 100);
            },

            detectDateFormat: function(date) {
                if (!date) return 'Missing';
                if (date.match(/^\d{4}$/)) return 'Year only (YYYY)';
                if (date.match(/^\d{4} \(/)) return 'Year with specific date';
                if (date.match(/^\d{4}-\d{4}$/)) return 'Year range';
                if (date.match(/^\d{1,2}(st|nd|rd|th) c\./)) return 'Century';
                if (date.match(/^AD \d+/)) return 'AD date';
                return 'Other format';
            },

            generateResearchPrompt: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                const topic = document.getElementById('research-topic').value || document.getElementById('research-topic-2').value || 'general history';
                this.showLoading();
                
                setTimeout(() => {
                    let prompt = `Research Query for: ${topic.toUpperCase()}\n`;
                    prompt += 'Location: Gipsy Hill, South London\n';
                    prompt += '=' .repeat(50) + '\n\n';
                    
                    prompt += `I need detailed historical information about ${topic} in the Gipsy Hill area of South London.\n\n`;
                    
                    prompt += 'Please provide:\n\n';
                    prompt += '1. CHRONOLOGICAL OVERVIEW\n';
                    prompt += `   - Key dates and events related to ${topic}\n`;
                    prompt += '   - How this topic evolved over time in the area\n';
                    prompt += '   - Important turning points or changes\n\n';
                    
                    prompt += '2. KEY FIGURES\n';
                    prompt += `   - Important people associated with ${topic} in this area\n`;
                    prompt += '   - Their contributions and significance\n';
                    prompt += '   - Connections to broader historical context\n\n';
                    
                    prompt += '3. LOCATIONS & LANDMARKS\n';
                    prompt += `   - Specific places related to ${topic}\n`;
                    prompt += '   - Buildings, streets, or sites of importance\n';
                    prompt += '   - What remains today vs what has been lost\n\n';
                    
                    prompt += '4. PRIMARY SOURCES\n';
                    prompt += '   - Archives that might hold relevant documents\n';
                    prompt += '   - Newspaper archives to search\n';
                    prompt += '   - Maps, photographs, or illustrations\n';
                    prompt += '   - Oral history collections\n\n';
                    
                    prompt += '5. CONNECTIONS\n';
                    prompt += `   - How ${topic} relates to other aspects of local history\n`;
                    prompt += '   - Links to wider London or national history\n';
                    prompt += '   - Social, economic, or cultural impacts\n\n';
                    
                    prompt += '6. GAPS IN KNOWLEDGE\n';
                    prompt += '   - What aspects need more research\n';
                    prompt += '   - Conflicting accounts to resolve\n';
                    prompt += '   - Myths vs documented facts\n\n';
                    
                    prompt += 'Please cite all sources and indicate confidence levels for any uncertain information.';
                    
                    this.showOutput('Research Query', prompt);
                }, 100);
            },

            generateArchiveSearch: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                const topic = document.getElementById('research-topic').value || document.getElementById('research-topic-2').value || 'Gipsy Hill history';
                this.showLoading();
                
                setTimeout(() => {
                    let output = 'ARCHIVE SEARCH STRATEGY\n';
                    output += `Topic: ${topic}\n`;
                    output += '=' .repeat(50) + '\n\n';
                    
                    output += 'RECOMMENDED ARCHIVES:\n\n';
                    
                    output += '1. Lambeth Archives\n';
                    output += '   Search terms:\n';
                    output += `   - "${topic}"\n`;
                    output += '   - "Gipsy Hill" AND ' + topic.split(' ').map(t => `"${t}"`).join(' OR ') + '\n';
                    output += '   - "Gipsy Hill" AND ' + topic.split(' ').map(t => `"${t}"`).join(' OR ') + '\n';
                    output += '   - "West Norwood" AND ' + topic.split(' ').map(t => `"${t}"`).join(' OR ') + '\n\n';
                    
                    output += '2. London Metropolitan Archives\n';
                    output += '   Collections to check:\n';
                    output += '   - Parish records (St Luke\'s West Norwood)\n';
                    output += '   - Metropolitan Board of Works\n';
                    output += '   - London County Council records\n';
                    output += '   - Maps and plans collection\n\n';
                    
                    output += '3. The National Archives (Kew)\n';
                    output += '   Relevant record series:\n';
                    output += '   - Census returns (HO 107, RG series)\n';
                    output += '   - Ordnance Survey maps (OS series)\n';
                    output += '   - Railway records (RAIL series)\n';
                    output += '   - War damage maps (HO 193)\n\n';
                    
                    output += '4. British Library Newspapers\n';
                    output += '   Search strategy:\n';
                    output += `   - Date range: 1800-1950\n`;
                    output += `   - Publications: South London Press, Norwood News\n`;
                    output += `   - Keywords: "Gipsy Hill" "${topic}"\n\n`;
                    
                    output += '5. Historic England Archive\n';
                    output += '   Search for:\n';
                    output += '   - Historic photographs\n';
                    output += '   - Building surveys\n';
                    output += '   - Archaeological reports\n\n';
                    
                    output += 'SEARCH TIPS:\n';
                    output += '- Try variant spellings: Gipsy/Gypsy Hill\n';
                    output += '- Include nearby areas: Norwood, Dulwich, Crystal Palace\n';
                    output += '- Check date ranges around known events\n';
                    output += '- Look for personal names mentioned in timeline\n';
                    output += '- Cross-reference with trade directories\n';
                    
                    this.showOutput('Archive Search Strategy', output);
                }, 100);
            },

            // New functions for Research tab
            generateNewspaperSearch: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                const topic = document.getElementById('research-topic-2').value || 'Gipsy Hill';
                this.showLoading();
                
                setTimeout(() => {
                    let output = 'NEWSPAPER SEARCH STRATEGY\n';
                    output += `Topic: ${topic}\n`;
                    output += '=' .repeat(50) + '\n\n';
                    
                    output += 'RECOMMENDED NEWSPAPER ARCHIVES:\n\n';
                    
                    output += '1. British Newspaper Archive\n';
                    output += '   Key publications:\n';
                    output += '   - South London Press (1865-present)\n';
                    output += '   - Norwood News (1881-1914)\n';
                    output += '   - South London Observer (1868-1936)\n';
                    output += '   - Camberwell & Peckham Times\n\n';
                    
                    output += '2. Search Terms:\n';
                    output += `   Primary: "${topic}" AND "Gipsy Hill"\n`;
                    output += `   Secondary: "${topic}" AND ("Gipsy Hill" OR "West Norwood")\n`;
                    output += `   Broader: "${topic}" AND ("Crystal Palace" OR "Dulwich")\n\n`;
                    
                    output += '3. Date Ranges to Focus:\n';
                    output += '   - 1850s-1860s: Railway development\n';
                    output += '   - 1870s-1890s: Victorian expansion\n';
                    output += '   - 1900s-1910s: Edwardian period\n';
                    output += '   - 1914-1918: WWI impact\n';
                    output += '   - 1920s-1930s: Interwar development\n';
                    output += '   - 1939-1945: WWII period\n';
                    output += '   - 1950s-1960s: Post-war reconstruction\n\n';
                    
                    output += '4. Types of Articles to Look For:\n';
                    output += '   - Local news and announcements\n';
                    output += '   - Planning applications and developments\n';
                    output += '   - Crime reports and court proceedings\n';
                    output += '   - Social events and community activities\n';
                    output += '   - Advertisements and business notices\n';
                    output += '   - Letters to the editor\n';
                    output += '   - Obituaries and personal notices\n';
                    
                    this.showOutput('Newspaper Search Strategy', output);
                }, 100);
            },

            generateMapSearch: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'MAP & VISUAL RESOURCES SEARCH\n';
                    output += '=' .repeat(50) + '\n\n';
                    
                    output += 'HISTORICAL MAP SOURCES:\n\n';
                    
                    output += '1. Ordnance Survey Maps\n';
                    output += '   - 1860s First Edition (1:2500)\n';
                    output += '   - 1890s Second Edition\n';
                    output += '   - 1910s Third Edition\n';
                    output += '   - 1930s Fourth Edition\n';
                    output += '   - 1950s National Grid series\n\n';
                    
                    output += '2. Online Map Collections:\n';
                    output += '   - National Library of Scotland (historic OS maps)\n';
                    output += '   - Old Maps Online\n';
                    output += '   - British Library map collection\n';
                    output += '   - London Metropolitan Archives\n';
                    output += '   - Lambeth Archives map collection\n\n';
                    
                    output += '3. Specialized Maps to Find:\n';
                    output += '   - Tithe maps (1830s-1840s)\n';
                    output += '   - Railway planning maps\n';
                    output += '   - Bomb damage maps (WWII)\n';
                    output += '   - Estate maps\n';
                    output += '   - Insurance maps (Goad plans)\n';
                    output += '   - Enclosure maps\n\n';
                    
                    output += '4. Visual Resources:\n';
                    output += '   - Historic England Archive (photographs)\n';
                    output += '   - London Picture Archive\n';
                    output += '   - Borough Photos collection\n';
                    output += '   - Lambeth Landmarks photo archive\n';
                    output += '   - Britain from Above (aerial photos)\n';
                    output += '   - Francis Frith Collection\n\n';
                    
                    output += '5. What to Look For:\n';
                    output += '   - Street layout changes\n';
                    output += '   - Lost buildings and landmarks\n';
                    output += '   - Field boundaries and land use\n';
                    output += '   - Railway and transport infrastructure\n';
                    output += '   - Public buildings and institutions\n';
                    output += '   - Parks and open spaces\n';
                    output += '   - Industrial sites\n';
                    
                    this.showOutput('Map & Visual Resources', output);
                }, 100);
            },

            generateCrossReference: function() {
                if (!this.dataLoaded) {
                    this.showError('Data not loaded');
                    return;
                }
                
                this.showLoading();
                setTimeout(() => {
                    let output = 'CROSS-REFERENCE CHECK\n';
                    output += '=' .repeat(50) + '\n\n';
                    
                    output += 'This report identifies timeline entries that should be cross-referenced with each other.\n\n';
                    
                    // Find related entries by analyzing descriptions
                    const connections = [];
                    
                    for (let i = 0; i < window.timelineData.length; i++) {
                        for (let j = i + 1; j < window.timelineData.length; j++) {
                            const entry1 = window.timelineData[i];
                            const entry2 = window.timelineData[j];
                            
                            // Check for shared keywords
                            const keywords1 = this.extractKeywords(entry1.description + ' ' + entry1.title);
                            const keywords2 = this.extractKeywords(entry2.description + ' ' + entry2.title);
                            
                            const shared = keywords1.filter(k => keywords2.includes(k));
                            
                            if (shared.length >= 2) {
                                connections.push({
                                    entry1: `${entry1.date}: ${entry1.title}`,
                                    entry2: `${entry2.date}: ${entry2.title}`,
                                    sharedKeywords: shared
                                });
                            }
                        }
                    }
                    
                    output += `Found ${connections.length} potential cross-references:\n\n`;
                    
                    connections.forEach(conn => {
                        output += `CONNECTION:\n`;
                        output += `  Entry 1: ${conn.entry1}\n`;
                        output += `  Entry 2: ${conn.entry2}\n`;
                        output += `  Shared concepts: ${conn.sharedKeywords.join(', ')}\n\n`;
                    });
                    
                    if (connections.length > 50) {
                        output += `... and ${connections.length - 50} more connections\n`;
                    }
                    
                    this.showOutput('Cross-Reference Check', output);
                }, 100);
            },

            extractKeywords: function(text) {
                // Simple keyword extraction
                const stopWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'up', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'between', 'under', 'again', 'further', 'then', 'once', 'was', 'were', 'is', 'are', 'been', 'be', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'ought', 'may', 'might', 'must', 'can', 'this', 'that', 'these', 'those', 'it', 'its'];
                
                return text.toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 3 && !stopWords.includes(word))
                    .filter((word, index, array) => array.indexOf(word) === index);
            },

            // Entry Editor Functions
            currentEntry: null,
            originalEntry: null,
            
            searchEntries: function(searchTerm) {
                const selector = document.getElementById('entry-selector');
                if (!selector) return;
                
                // Check if data is loaded
                if (!this.dataLoaded || !window.timelineData) {
                    selector.innerHTML = '<option value="">Loading data...</option>';
                    // Try to load data
                    if (!this.dataLoaded) {
                        this.init();
                    }
                    return;
                }
                
                selector.innerHTML = '<option value="">-- Select an entry to edit --</option>';
                
                // If no search term or too short, show all entries
                if (!searchTerm || searchTerm.length === 0) {
                    // Show all entries if search is empty
                    window.timelineData.forEach((entry, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${entry.date} - ${entry.title}`;
                        selector.appendChild(option);
                    });
                    return;
                }
                
                // Search through entries
                const term = searchTerm.toLowerCase();
                let matchCount = 0;
                window.timelineData.forEach((entry, index) => {
                    if (entry.title.toLowerCase().includes(term) || 
                        entry.date.toLowerCase().includes(term) ||
                        (entry.description && entry.description.toLowerCase().includes(term))) {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${entry.date} - ${entry.title}`;
                        selector.appendChild(option);
                        matchCount++;
                    }
                });
                
                if (matchCount === 0) {
                    selector.innerHTML = '<option value="">No matches found</option>';
                }
            },
            
            loadEntry: function(index) {
                if (index === '') {
                    document.getElementById('entry-form').style.display = 'none';
                    return;
                }
                
                const entry = window.timelineData[index];
                if (!entry) return;
                
                this.currentEntry = index;
                this.originalEntry = JSON.parse(JSON.stringify(entry));
                
                // Populate form fields
                document.getElementById('edit-date').value = entry.date || '';
                document.getElementById('edit-title').value = entry.title || '';
                document.getElementById('edit-description').value = entry.description || '';
                document.getElementById('edit-category').value = entry.category || '';
                document.getElementById('edit-importance').value = entry.importance || 'minor';
                document.getElementById('edit-icon').value = entry.icon || '';
                document.getElementById('edit-citations').value = entry.citations ? entry.citations.join(', ') : '';
                document.getElementById('edit-image').value = entry.image || '';
                document.getElementById('edit-image-caption').value = entry.imageCaption || '';
                
                // Auto-populate commit message and PR description
                document.getElementById('commit-message').value = `Update ${entry.title} (${entry.date})`;
                document.getElementById('pr-description').value = `## Timeline Entry Update

**Entry:** ${entry.title}
**Date:** ${entry.date}
**Category:** ${entry.category || 'Not specified'}

### Changes Made:
(Will be updated when you make changes)

### Reason for Update:
(Please add your reason here)`;
                
                document.getElementById('entry-form').style.display = 'block';
            },
            
            newEntry: function() {
                this.currentEntry = 'new';
                this.originalEntry = null;
                
                // Clear form fields
                document.getElementById('edit-date').value = '';
                document.getElementById('edit-title').value = '';
                document.getElementById('edit-description').value = '';
                document.getElementById('edit-category').value = '';
                document.getElementById('edit-importance').value = 'minor';
                document.getElementById('edit-icon').value = '';
                document.getElementById('edit-citations').value = '';
                document.getElementById('edit-image').value = '';
                document.getElementById('edit-image-caption').value = '';
                
                // Auto-populate commit message and PR description for new entry
                document.getElementById('commit-message').value = 'Add new timeline entry';
                document.getElementById('pr-description').value = `## New Timeline Entry

### Entry Details:
(Will be populated when you fill in the form)

### Reason for Addition:
(Please explain why this entry is being added)

### Sources:
(Please list your sources for this new entry)`;
                
                document.getElementById('entry-form').style.display = 'block';
                document.getElementById('entry-selector').value = '';
            },
            
            resetForm: function() {
                if (this.currentEntry === 'new') {
                    this.newEntry();
                } else if (this.currentEntry !== null) {
                    this.loadEntry(this.currentEntry);
                }
            },
            
            getFormData: function() {
                const citations = document.getElementById('edit-citations').value
                    .split(',')
                    .map(c => c.trim())
                    .filter(c => c);
                
                const formData = {};
                
                // Only include fields that have values
                const date = document.getElementById('edit-date').value;
                if (date) formData.date = date;
                
                const title = document.getElementById('edit-title').value;
                if (title) formData.title = title;
                
                const description = document.getElementById('edit-description').value;
                if (description) formData.description = description;
                
                const category = document.getElementById('edit-category').value;
                if (category) formData.category = category;
                
                const importance = document.getElementById('edit-importance').value;
                if (importance) formData.importance = importance;
                
                const icon = document.getElementById('edit-icon').value;
                if (icon) formData.icon = icon;
                
                if (citations.length > 0) {
                    formData.citations = citations;
                }
                
                const image = document.getElementById('edit-image').value;
                if (image) formData.image = image;
                
                const imageCaption = document.getElementById('edit-image-caption').value;
                if (imageCaption) formData.imageCaption = imageCaption;
                
                // For existing entries, preserve fields that weren't changed
                if (this.currentEntry !== 'new' && this.originalEntry) {
                    // Merge with original, keeping unchanged fields
                    return Object.assign({}, this.originalEntry, formData);
                }
                
                return formData;
            },
            
            previewChanges: function() {
                const newData = this.getFormData();
                let output = 'PREVIEW OF CHANGES\n';
                output += '=' .repeat(50) + '\n\n';
                
                if (this.currentEntry === 'new') {
                    output += 'NEW ENTRY:\n\n';
                    output += JSON.stringify(newData, null, 2);
                } else {
                    output += 'ORIGINAL ENTRY:\n';
                    output += JSON.stringify(this.originalEntry, null, 2);
                    output += '\n\nMODIFIED ENTRY:\n';
                    output += JSON.stringify(newData, null, 2);
                    
                    output += '\n\nCHANGES:\n';
                    for (const key in newData) {
                        if (JSON.stringify(newData[key]) !== JSON.stringify(this.originalEntry[key])) {
                            output += `- ${key}: ${JSON.stringify(this.originalEntry[key])} → ${JSON.stringify(newData[key])}\n`;
                        }
                    }
                }
                
                this.showOutput('Change Preview', output);
            },
            
            createPR: function() {
                const commitMsg = document.getElementById('commit-message').value.trim();
                const prDesc = document.getElementById('pr-description').value.trim();
                
                // Validate required fields
                if (!commitMsg) {
                    this.showError('⚠️ Commit message is required!');
                    document.getElementById('commit-message').style.borderColor = '#e74c3c';
                    document.getElementById('commit-message').focus();
                    return;
                }
                
                if (!prDesc) {
                    this.showError('⚠️ PR description is required!');
                    document.getElementById('pr-description').style.borderColor = '#e74c3c';
                    document.getElementById('pr-description').focus();
                    return;
                }
                
                // Reset border colors
                document.getElementById('commit-message').style.borderColor = '#3a3a4e';
                document.getElementById('pr-description').style.borderColor = '#3a3a4e';
                
                const newData = this.getFormData();
                
                // Show preview and confirmation
                this.showPreviewAndConfirm(newData, commitMsg, prDesc);
            },
            
            showPreviewAndConfirm: function(entryData, commitMsg, prDesc) {
                const modalDiv = document.createElement('div');
                modalDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                
                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'background: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%); color: white; padding: 30px; border-radius: 10px; max-width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
                
                let htmlContent = '<h2 style="margin-bottom: 20px; color: #3498db;">📝 Review Your Changes</h2>';
                
                // Show what will be changed
                htmlContent += '<div style="background: #1a1a2e; padding: 15px; border-radius: 5px; margin-bottom: 20px;">';
                htmlContent += '<h3 style="color: #27ae60; margin-bottom: 10px;">Entry Details:</h3>';
                
                if (this.currentEntry === 'new') {
                    htmlContent += '<p style="color: #f39c12; margin-bottom: 10px;">➕ <strong>Creating New Entry</strong></p>';
                } else {
                    htmlContent += '<p style="color: #f39c12; margin-bottom: 10px;">✏️ <strong>Updating Existing Entry</strong></p>';
                }
                
                htmlContent += '<table style="width: 100%; border-collapse: collapse;">';
                if (entryData.date) htmlContent += `<tr><td style="padding: 5px; color: #95a5a6;">Date:</td><td style="padding: 5px;">${entryData.date}</td></tr>`;
                if (entryData.title) htmlContent += `<tr><td style="padding: 5px; color: #95a5a6;">Title:</td><td style="padding: 5px;">${entryData.title}</td></tr>`;
                if (entryData.category) htmlContent += `<tr><td style="padding: 5px; color: #95a5a6;">Category:</td><td style="padding: 5px;">${entryData.category}</td></tr>`;
                if (entryData.importance) htmlContent += `<tr><td style="padding: 5px; color: #95a5a6;">Importance:</td><td style="padding: 5px;">${entryData.importance}</td></tr>`;
                if (entryData.icon) htmlContent += `<tr><td style="padding: 5px; color: #95a5a6;">Icon:</td><td style="padding: 5px;">${entryData.icon}</td></tr>`;
                htmlContent += '</table>';
                
                if (entryData.description) {
                    htmlContent += '<div style="margin-top: 10px;">';
                    htmlContent += '<strong style="color: #95a5a6;">Description:</strong>';
                    htmlContent += `<p style="margin-top: 5px; padding: 10px; background: #2c3e50; border-radius: 5px;">${entryData.description.substring(0, 200)}${entryData.description.length > 200 ? '...' : ''}</p>`;
                    htmlContent += '</div>';
                }
                htmlContent += '</div>';
                
                // Show commit details
                htmlContent += '<div style="background: #1a1a2e; padding: 15px; border-radius: 5px; margin-bottom: 20px;">';
                htmlContent += '<h3 style="color: #3498db; margin-bottom: 10px;">Commit Details:</h3>';
                htmlContent += `<p><strong>Message:</strong> ${commitMsg}</p>`;
                htmlContent += `<p style="margin-top: 10px;"><strong>PR Description:</strong></p>`;
                htmlContent += `<p style="padding: 10px; background: #2c3e50; border-radius: 5px; margin-top: 5px;">${prDesc}</p>`;
                htmlContent += '</div>';
                
                // Action buttons
                htmlContent += '<div style="display: flex; gap: 10px; justify-content: center;">';
                htmlContent += '<button onclick="adminTools.confirmAndGenerateCommands(); this.parentElement.parentElement.parentElement.remove();" style="background: #27ae60; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 16px;">✅ Confirm & Generate PR</button>';
                htmlContent += '<button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #e74c3c; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 16px;">❌ Cancel</button>';
                htmlContent += '</div>';
                
                contentDiv.innerHTML = htmlContent;
                modalDiv.appendChild(contentDiv);
                document.body.appendChild(modalDiv);
            },
            
            confirmAndGenerateCommands: function() {
                const commitMsg = document.getElementById('commit-message').value.trim();
                const prDesc = document.getElementById('pr-description').value.trim();
                const newData = this.getFormData();
                
                // Generate the git commands for creating a PR that modifies timeline-data.js
                let commands = '#!/bin/bash\n\n';
                commands += '# GitHub PR Creation Script\n';
                commands += '# This script will create a pull request with your timeline changes\n\n';
                
                // Create a new branch
                const branchName = `timeline-update-${Date.now()}`;
                commands += `echo "Creating new branch: ${branchName}"\n`;
                commands += `git checkout -b ${branchName}\n\n`;
                
                // Generate the modification script
                commands += `echo "Creating timeline update script..."\n`;
                commands += `cat > update_timeline.js << 'EOF'\n`;
                commands += `const fs = require('fs');\n`;
                commands += `const content = fs.readFileSync('timeline-data.js', 'utf8');\n`;
                commands += `let updatedContent = content;\n\n`;
                
                if (this.currentEntry === 'new') {
                    commands += `// Add new entry\n`;
                    commands += `const newEntry = ${JSON.stringify(newData, null, 2)};\n`;
                    commands += `const arrayEndIndex = updatedContent.lastIndexOf('];');\n`;
                    commands += `const lastEntryIndex = updatedContent.lastIndexOf('}', arrayEndIndex);\n`;
                    commands += `const insertion = ',\\n    ' + JSON.stringify(newEntry, null, 2).split('\\n').map((line, i) => i === 0 ? line : '    ' + line).join('\\n');\n`;
                    commands += `updatedContent = updatedContent.slice(0, lastEntryIndex + 1) + insertion + updatedContent.slice(lastEntryIndex + 1);\n`;
                } else {
                    commands += `// Update existing entry\n`;
                    commands += `const oldEntry = ${JSON.stringify(this.originalEntry, null, 2)};\n`;
                    commands += `const newEntry = ${JSON.stringify(newData, null, 2)};\n`;
                    
                    // Use a more robust replacement method
                    commands += `// Find and replace the entry based on date\n`;
                    commands += `const entryRegex = new RegExp(\n`;
                    commands += `  '\\\\{[^}]*"date"\\\\s*:\\\\s*"${this.originalEntry.date.replace(/[.*+?^${}()|[\]\\]/g, '\\\\$&')}"[^}]*\\\\}',\n`;
                    commands += `  's'\n`;
                    commands += `);\n`;
                    commands += `const formattedEntry = JSON.stringify(newEntry, null, 2).split('\\n').map((line, i) => i === 0 ? line : '    ' + line).join('\\n');\n`;
                    commands += `updatedContent = updatedContent.replace(entryRegex, formattedEntry);\n`;
                }
                
                commands += `\nfs.writeFileSync('timeline-data.js', updatedContent);\n`;
                commands += `console.log('✅ Timeline updated successfully');\n`;
                commands += `EOF\n\n`;
                
                commands += `echo "Running update script..."\n`;
                commands += `node update_timeline.js\n\n`;
                
                commands += `echo "Committing changes..."\n`;
                commands += `git add timeline-data.js\n`;
                commands += `git commit -m "${commitMsg.replace(/"/g, '\\"')}"\n\n`;
                
                commands += `echo "Pushing branch to origin..."\n`;
                commands += `git push -u origin ${branchName}\n\n`;
                
                commands += `echo "Creating pull request..."\n`;
                commands += `# If you have GitHub CLI installed:\n`;
                commands += `if command -v gh &> /dev/null; then\n`;
                commands += `    gh pr create --title "${commitMsg.replace(/"/g, '\\"')}" --body "${prDesc.replace(/"/g, '\\"').replace(/\n/g, '\\n')}"\n`;
                commands += `    echo "✅ Pull request created successfully!"\n`;
                commands += `else\n`;
                commands += `    echo "GitHub CLI not found. Please visit:"\n`;
                commands += `    echo "https://github.com/danieledge/Fogh-timeline/compare/${branchName}?expand=1"\n`;
                commands += `    echo "to create the pull request manually."\n`;
                commands += `fi\n\n`;
                
                commands += `# Clean up\n`;
                commands += `rm update_timeline.js\n`;
                commands += `echo "Done! Your pull request has been created."\n`;
                
                this.showOutput('Pull Request Script', commands);
                this.copyToClipboard(commands);
                
                // Show success message with instructions
                const successMsg = document.createElement('div');
                successMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); color: white; padding: 30px; border-radius: 10px; z-index: 10000; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 500px;';
                successMsg.innerHTML = `
                    <h3 style="margin-bottom: 15px;">✅ Script Generated!</h3>
                    <p style="margin-bottom: 15px;">The PR creation script has been copied to your clipboard.</p>
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <p style="margin-bottom: 10px;"><strong>To submit your changes:</strong></p>
                        <ol style="margin-left: 20px; line-height: 1.6;">
                            <li>Save the script as: <code>create_pr.sh</code></li>
                            <li>Make it executable: <code>chmod +x create_pr.sh</code></li>
                            <li>Run it: <code>./create_pr.sh</code></li>
                        </ol>
                    </div>
                    <button onclick="this.parentElement.remove()" style="background: white; color: #27ae60; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Close</button>
                `;
                document.body.appendChild(successMsg);
            },
            
            clearForm: function() {
                // Reset all form fields
                document.getElementById('entry-search').value = '';
                document.getElementById('edit-date').value = '';
                document.getElementById('edit-title').value = '';
                document.getElementById('edit-description').value = '';
                document.getElementById('edit-category').selectedIndex = 0;
                document.getElementById('edit-importance').selectedIndex = 0;
                document.getElementById('edit-icon').selectedIndex = 0;
                document.getElementById('edit-citations').value = '';
                document.getElementById('edit-image').value = '';
                document.getElementById('edit-image-caption').value = '';
                document.getElementById('commit-message').value = '';
                document.getElementById('pr-description').value = '';
                
                // Reset state
                this.currentEntry = null;
                this.originalEntry = null;
                
                // Clear search results
                const resultsDiv = document.getElementById('search-results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = '';
                    resultsDiv.style.display = 'none';
                }
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            adminTools.init();
        });
    </script>
</body>
</html>
