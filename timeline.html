<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Gipsy Hill Historical Timeline</title>
    <!-- Removed Swiper - using simple pagination instead -->
    <script>
        // Version-based cache busting
        var APP_VERSION = '2.85'; // Update this with each release - New carousel file name
        window.APP_VERSION = APP_VERSION; // Make it globally accessible
        
        // Cache busting logic
        (function() {
            var urlParams = new URLSearchParams(window.location.search);
            var noCache = urlParams.get('cache') === 'false';
            
            // Use version for cache busting, or timestamp if noCache is set
            var cacheBust = noCache ? '?v=' + Date.now() : '?v=' + APP_VERSION;
            
            // Check if user has outdated version cached
            var lastVersion = localStorage.getItem('app-version');
            if (lastVersion && lastVersion !== APP_VERSION) {
                // Version has changed, force refresh of all resources
                localStorage.setItem('app-version', APP_VERSION);
                // Clear any service worker caches if they exist
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        names.forEach(function(name) {
                            caches.delete(name);
                        });
                    });
                }
            } else if (!lastVersion) {
                localStorage.setItem('app-version', APP_VERSION);
            }
            
            // Add aggressive anti-caching meta tags if cache=false or version changed
            if (noCache || lastVersion !== APP_VERSION) {
                // HTTP 1.1
                var pragmaMeta = document.createElement('meta');
                pragmaMeta.setAttribute('http-equiv', 'pragma');
                pragmaMeta.setAttribute('content', 'no-cache');
                document.head.appendChild(pragmaMeta);
                
                // HTTP 1.0
                var expiresMeta = document.createElement('meta');
                expiresMeta.setAttribute('http-equiv', 'expires');
                expiresMeta.setAttribute('content', '0');
                document.head.appendChild(expiresMeta);
                
                // Proxies
                var cacheControlMeta = document.createElement('meta');
                cacheControlMeta.setAttribute('http-equiv', 'cache-control');
                cacheControlMeta.setAttribute('content', 'no-cache, no-store, must-revalidate, private, max-age=0');
                document.head.appendChild(cacheControlMeta);
                
                // Force page reload if navigated back to
                window.addEventListener('pageshow', function(event) {
                    if (event.persisted) {
                        window.location.reload();
                    }
                });
            }
            
            // Add CSS with cache busting
            var cssLink = document.createElement('link');
            cssLink.rel = 'stylesheet';
            cssLink.href = 'timeline.css' + cacheBust;
            document.head.appendChild(cssLink);
            
            // Leftline carousel CSS will be included in the bundle
            
            // Store cache bust value for JS files
            window.cacheBust = cacheBust;
            window.noCache = noCache;
        })();
    </script>
    <style>
        /* Minimal inline styles for initial render */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        /* Loading state */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading timeline...</div>
    
    <button class="menu-toggle" id="menu-toggle" aria-label="Menu" style="display:none;">
        <svg viewBox="0 0 24 24" fill="currentColor"></svg>
    </button>
    
    <div class="menu-panel" id="menu-panel">
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
            <svg class="theme-toggle-icon sun" viewBox="0 0 24 24" fill="currentColor"></svg>
            <svg class="theme-toggle-icon moon" viewBox="0 0 24 24" fill="currentColor"></svg>
            <span class="theme-text">Dark Mode</span>
        </button>
        
        
        <button class="add-entry-button" id="add-entry-button" aria-label="Add New Entry">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
            </svg>
            <span>Suggest Entry/Amendment</span>
        </button>
        
        <!-- Export button will be dynamically inserted here if export=true -->
        
        <button class="references-button" id="references-button" aria-label="References">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H9V10H15V15L13,19H10Z"/>
            </svg>
            <span>References</span>
        </button>
        
        <button class="about-button" id="about-button" aria-label="About">
            <svg viewBox="0 0 24 24" fill="currentColor"></svg>
            <span>About</span>
        </button>
        
        <button class="reset-preferences-button" id="reset-preferences-button" aria-label="Reset Preferences">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z" transform="rotate(45 12 12)"/>
            </svg>
            <span>Reset Preferences</span>
        </button>
    </div>

    <div class="float-element"></div>
    <div class="float-element"></div>
    <div class="float-element"></div>

    <div class="header" style="display:none;">
        <div class="header-content">
            <!-- Original SVG logo commented out
            <div class="fogh-logo-header">
                <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 450 96" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
            -->
            <div class="fogh-logo-header">
                <img src="images/wide_history_fogh.png" alt="History of Gipsy Hill" />
            </div>
            <!-- <h1>Historical Timeline</h1> -->
            <p>2,000 years of Gipsy Hill history ‚Äì from ancient woodlands to modern community life</p>
            <div class="header-link">
                <a href="https://gipsyhillfriends.org" target="_blank" rel="noopener">gipsyhillfriends.org</a>
            </div>
            <div class="wip-notice" id="wip-notice">
                <button class="wip-close" id="wip-close" aria-label="Close notice">√ó</button>
                <strong>üéâ Version 2.10 now available!</strong> 
                <a href="https://github.com/danieledge/Fogh-timeline#-latest-updates" target="_blank" rel="noopener">App updates</a> ‚Ä¢ 
                <a href="https://github.com/danieledge/Fogh-timeline/blob/main/TIMELINE_DATA_CHANGES.md" target="_blank" rel="noopener">Timeline data changes</a> ‚Ä¢ 
                Please note this is beta software. It's very likely that some data will be inaccurate - it's our hope that this will improve over time with your <a href="#" onclick="document.getElementById('add-entry-button').click(); return false;">contributions</a>.
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- FILTER TOGGLE BUTTON                                                -->
    <!-- Fixed button under hamburger menu                                   -->
    <!-- =================================================================== -->
    <button class="filter-toggle-button" id="filter-toggle-button" aria-label="Toggle filters">
        <svg class="filter-icon" viewBox="0 0 24 24" width="24" height="24">
            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" fill="currentColor"/>
        </svg>
        <span class="filter-indicator" style="display: none;"></span>
    </button>

    <!-- =================================================================== -->
    <!-- FILTER DRAWER                                                       -->
    <!-- Slide-out drawer panel                                              -->
    <!-- =================================================================== -->
    <div class="filter-backdrop" id="filter-backdrop"></div>
    <div class="filter-drawer" id="filter-drawer">
        <div class="filter-drawer-header">
            <div class="filter-header-left">
                <button class="filter-drawer-close" id="filter-drawer-close" aria-label="Close filters">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                    </svg>
                </button>
                <button class="clear-all-filters" id="clear-all-filters" style="display: none;">Clear All</button>
            </div>
            <div class="filter-header-center">
                <h3>Search & Filter</h3>
                <div class="filter-status" id="filter-status"></div>
            </div>
            <div class="filter-header-right"></div>
        </div>
        <div class="filter-drawer-content">
            <!-- Timeline Search - Always visible -->
            <div class="filter-section search-section">
                <div class="timeline-search-container">
                    <div class="timeline-search">
                        <input type="text" 
                               class="timeline-search-input" 
                               placeholder="Search timeline entries..." 
                               aria-label="Search timeline">
                    </div>
                </div>
            </div>
            
            <!-- More Options - Collapsible -->
            <div class="filter-section collapsible-section more-options-section">
                <h4 class="collapsible-header">
                    <span>More Options</span>
                    <svg class="collapse-icon" viewBox="0 0 24 24" width="20" height="20">
                        <path d="M7 10l5 5 5-5z" fill="currentColor"/>
                    </svg>
                </h4>
                <div class="collapsible-content">
                    <!-- Time Period Filter -->
                    <div class="filter-subsection">
                        <h5>Filter by Time Period</h5>
                        <div class="visual-timeline-container">
                        <div class="visual-timeline">
                            <div class="timeline-periods">
                                <!-- Periods will be generated by JavaScript -->
                            </div>
                            <div class="timeline-histogram">
                                <!-- Event density bars will be generated here -->
                            </div>
                            <div class="timeline-selection">
                                <div class="selection-handle left" data-handle="left">
                                    <div class="handle-grip"></div>
                                </div>
                                <div class="selection-range">
                                    <div class="range-label start"></div>
                                    <div class="range-label end"></div>
                                </div>
                                <div class="selection-handle right" data-handle="right">
                                    <div class="handle-grip"></div>
                                </div>
                            </div>
                            <div class="timeline-labels">
                                <!-- Year labels will be generated here -->
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Categories -->
                    <div class="filter-subsection">
                        <h5>Filter by Category</h5>
                        <div class="category-filter-container" id="category-filter-container">
                            <!-- Category pills will be added here by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Minor Entries Toggle -->
                    <div class="filter-subsection">
                        <label class="minor-toggle-container">
                            <input type="checkbox" id="filter-minor-toggle" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Show Minor Entries</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- TIMELINE CONTAINER                                                  -->
    <!-- Main container where timeline events are dynamically inserted       -->
    <!-- =================================================================== -->
    <div class="timeline-container">
        <div class="timeline-line"></div>
        <div id="timeline-items"></div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal-content export-modal-content">
            <button class="modal-close" id="export-modal-close" aria-label="Close">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="export-content">
                <h2>Export Timeline</h2>
                <p>Enter the password to export the timeline content:</p>
                <form id="export-form">
                    <input type="password" id="export-password" placeholder="Enter password" autocomplete="off">
                    <button type="submit" class="export-submit">Export to Text</button>
                </form>
                <div id="export-error" class="export-error"></div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal-overlay" id="image-modal">
        <div class="modal-content image-modal-content">
            <button class="modal-close" id="image-modal-close" aria-label="Close">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            
            <!-- Toggle Controls Button -->
            <button class="controls-toggle" id="controls-toggle" aria-label="Toggle controls" title="Toggle controls (C)">
                <img src="icons/controls.svg" alt="Toggle controls" width="20" height="20" id="controls-toggle-icon">
            </button>
            
            <!-- Navigation Hint -->
            <div class="zoom-navigation-hint" id="zoom-navigation-hint">
                Use arrow keys to pan ‚Ä¢ Scroll to zoom ‚Ä¢ Double-click to zoom ‚Ä¢ Space to reset
            </div>
            
            <!-- Main image container -->
            <div class="image-modal-wrapper" id="image-modal-wrapper">
                <img id="modal-image" src="" alt="">
            </div>
            
            <!-- Caption - Outside image frame -->
            <div id="modal-image-caption" class="modal-image-caption"></div>
            
            <!-- Zoom Controls - At bottom -->
            <div class="image-zoom-controls" id="image-zoom-controls">
                <button class="zoom-btn" id="zoom-out" aria-label="Zoom out" title="Zoom out (-)">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M19 13H5V11H19V13Z" fill="currentColor"/>
                    </svg>
                </button>
                <span class="zoom-level" id="zoom-level">100%</span>
                <button class="zoom-btn" id="zoom-in" aria-label="Zoom in" title="Zoom in (+)">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="currentColor"/>
                    </svg>
                </button>
                <button class="zoom-btn" id="zoom-reset" aria-label="Reset view" title="Reset view (R)">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="currentColor"/>
                    </svg>
                </button>
                <button class="zoom-btn" id="zoom-fit" aria-label="Fit to screen" title="Fit to screen (F)">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path d="M5 5H10V7H7V10H5V5M14 5H19V10H17V7H14V5M17 14H19V19H14V17H17V14M10 17V19H5V14H7V17H10Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            
            <!-- Minimap -->
            <div class="image-minimap" id="image-minimap">
                <img id="minimap-image" src="" alt="">
                <div class="image-minimap-viewport" id="minimap-viewport"></div>
            </div>
        </div>
    </div>

    <!-- Submission Modal -->
    <div class="modal-overlay" id="submission-modal">
        <div class="modal-content submission-modal-content">
            <button class="modal-close" id="submission-modal-close" aria-label="Close">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="submission-content">
                <h2 id="submission-title">Submit New Timeline Entry</h2>
                <div class="submission-tabs">
                    <button class="submission-tab active" data-type="new">Suggest Entry</button>
                    <button class="submission-tab" data-type="amendment">Suggest Amendment</button>
                </div>
                
                <form id="submission-form" class="staticman-form">
                    <!-- Removed redirect to handle success in JavaScript instead -->
                    <input type="hidden" name="options[slug]" value="timeline-submissions">
                    <input type="hidden" name="fields[submissionType]" id="submissionType" value="new">
                    
                    <!-- Amendment specific field -->
                    <div class="form-group amendment-only" style="display:none;">
                        <label for="originalEntryDate">Entry to Amend <span class="required">*</span></label>
                        <select name="fields[originalEntryDate]" id="originalEntryDate" required>
                            <option value="">Select an entry...</option>
                        </select>
                        
                    </div>
                    
                    <!-- Common fields -->
                    <div class="form-group">
                        <label for="date" class="new-only">Date/Period <span class="required">*</span></label>
                        <label for="date" class="amendment-only" style="display:none;">Date <span class="required">*</span></label>
                        <input type="text" name="fields[date]" id="date" placeholder="e.g., 1854 or 1800-1850">
                        <small class="new-only">Enter a year, date range, or period</small>
                        <small class="amendment-only" style="display:none;">Edit the date if needed</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="title" class="new-only">Title <span class="required">*</span></label>
                        <label for="title" class="amendment-only" style="display:none;">Title <span class="required">*</span></label>
                        <input type="text" name="fields[title]" id="title">
                        <small class="new-only">Give your entry a clear, descriptive title</small>
                        <small class="amendment-only" style="display:none;">Edit the title if needed</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="description" class="new-only">Description <span class="required">*</span></label>
                        <label for="description" class="amendment-only" style="display:none;">Description <span class="required">*</span></label>
                        <textarea name="fields[description]" id="description" rows="5"></textarea>
                        <small class="new-only">Include as much detail as possible about this historical event or place</small>
                        <small class="amendment-only" style="display:none;">Edit the description as needed</small>
                    </div>
                    
                    <div class="form-group amendment-only" style="display:none;">
                        <label for="amendments">What needs to be changed? <span class="required">*</span></label>
                        <textarea name="fields[amendments]" id="amendments" rows="5" placeholder="Explain what should be changed and why. For example: 'The date should be 1855 not 1854 based on...' or 'Please add the following information...'"></textarea>
                        <small>Describe specific changes needed and provide sources if possible</small>
                    </div>
                    
                    
                    <div class="form-group">
                        <label for="citations">Sources & References</label>
                        <textarea name="fields[citations]" id="citations" rows="3" placeholder="Please provide sources for your information (e.g., 'Lambeth Archives ref: IV/90/1', 'The Times, 15 March 1890, p.7', 'Personal recollection from 1985', 'Family photo album dated 1920s')"></textarea>
                        <small>Help us verify historical accuracy by citing your sources - archives, newspapers, books, or personal memories</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="image-urls">Image URLs (optional)</label>
                        <textarea name="fields[imageUrls]" id="image-urls" rows="3" placeholder="Paste image URLs here, one per line:&#10;https://i.postimg.cc/abc123/old-church-photo.jpg&#10;https://i.postimg.cc/xyz789/gipsy-hill-map-1890.png"></textarea>
                        <small>To upload images: Visit <a href="https://postimg.cc" target="_blank" style="color: #1f6c49;">postimg.cc</a> ‚Üí Upload ‚Üí Copy direct link ‚Üí Paste above</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="image-captions">Image Captions (optional)</label>
                        <textarea name="fields[imageCaptions]" id="image-captions" rows="3" placeholder="Describe each image (one per line, matching order above):&#10;St. Luke's Church viewed from Gipsy Road, circa 1965&#10;Ordnance Survey map showing the area before development"></textarea>
                        <small>Provide a caption for each image URL above, in the same order</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="image-sources">Image Sources/Credits (optional)</label>
                        <textarea name="fields[imageSources]" id="image-sources" rows="2" placeholder="Credit for each image (one per line):&#10;Lambeth Archives, Ref: LP12/4&#10;National Library of Scotland, CC BY-NC-SA"></textarea>
                        <small>Attribution, archive reference, photographer name, or "Personal collection"</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="name">Your Name <span class="required">*</span></label>
                        <input type="text" name="fields[name]" id="name" required>
                        <small>Your name will appear on the submitted entry publicly available on GitHub (use first name or nickname if preferred)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Your Email <span class="required">*</span></label>
                        <input type="email" name="fields[email]" id="email" required>
                        <small>Kept private - encrypted for security, only used to identify repeat submissions</small>
                    </div>
                    
                    <div class="form-error" id="submission-error" style="display:none;"></div>
                    <div class="form-success" id="submission-success" style="display:none;">
                        <p>Thank you! Your submission has been received and will be reviewed by our moderators.</p>
                        <p><small>Note: All submitted information except your email (name, date, title, description, sources, amendments) will be publicly visible on GitHub.</small></p>
                    </div>
                    
                    <button type="submit" class="submit-button" id="submit-button">Submit for Review</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Submission Confirmation Modal -->
    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal-content confirmation-modal">
            <h3>Confirm Your Submission</h3>
            
            <div class="privacy-notice">
                <p><strong>üì¢ Public Submission:</strong> All fields will be visible on GitHub. <a href="https://github.com/danieledge/Fogh-timeline/issues" target="_blank">View all</a></p>
            </div>
            
            <div class="confirmation-info">
                <p><strong>Information to be published:</strong></p>
                <div class="public-fields">
                    <div class="field-preview">
                        <span class="field-label">Your name:</span>
                        <span id="confirm-name" class="field-value"></span>
                    </div>
                    <div class="field-preview">
                        <span class="field-label">Date:</span>
                        <span id="confirm-date" class="field-value"></span>
                    </div>
                    <div class="field-preview">
                        <span class="field-label">Title:</span>
                        <span id="confirm-title" class="field-value"></span>
                    </div>
                    <div class="field-preview">
                        <span class="field-label">Description:</span>
                        <span id="confirm-description" class="field-value"></span>
                    </div>
                    <div class="field-preview amendment-field" style="display:none;">
                        <span class="field-label">Amendment details:</span>
                        <span id="confirm-amendments" class="field-value"></span>
                    </div>
                    <div class="field-preview">
                        <span class="field-label">Sources/Citations:</span>
                        <span id="confirm-citations" class="field-value">(if provided)</span>
                    </div>
                    <div class="field-preview" id="confirm-images-container" style="display:none;">
                        <span class="field-label">Image URLs:</span>
                        <span id="confirm-images" class="field-value"></span>
                    </div>
                    <div class="field-preview" id="confirm-captions-container" style="display:none;">
                        <span class="field-label">Image Captions:</span>
                        <span id="confirm-captions" class="field-value"></span>
                    </div>
                    <div class="field-preview" id="confirm-sources-container" style="display:none;">
                        <span class="field-label">Image Sources:</span>
                        <span id="confirm-sources" class="field-value"></span>
                    </div>
                </div>
                
                <p class="privacy-note">
                    <svg class="icon-lock" viewBox="0 0 24 24" width="16" height="16">
                        <path d="M12 2C9.243 2 7 4.243 7 7v3H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1V7c0-2.757-2.243-5-5-5zM9 7c0-1.654 1.346-3 3-3s3 1.346 3 3v3H9V7zm4 10.723V20h-2v-2.277a2 2 0 1 1 2 0z"/>
                    </svg>
                    Your email will be kept private and encrypted
                </p>
            </div>
            
            <div class="confirmation-checkbox">
                <label>
                    <input type="checkbox" id="dont-show-again">
                    Don't show this confirmation again
                </label>
            </div>
            
            <div class="confirmation-buttons">
                <button class="button-secondary" id="cancel-submission">Cancel</button>
                <button class="button-primary" id="proceed-submission">Submit</button>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- CITATION MODAL                                                      -->
    <!-- Shows individual citation when clicked from timeline                -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="citation-modal">
        <div class="modal-content citation-modal-content">
            <div class="citation-modal-header">
                <h2 class="citation-modal-title">Citation Details</h2>
                <div id="citation-nav-controls" class="citation-nav-controls">
                    <!-- Navigation controls will be inserted here -->
                </div>
                <button class="modal-close" id="citation-modal-close" aria-label="Close">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div id="citation-modal-body" class="citation-modal-body">
                <!-- Citation content will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- =================================================================== -->
    <!-- KEY MODAL                                                           -->
    <!-- Shows quality/status key when badges are clicked                    -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="key-modal">
        <div class="modal-content key-modal-content">
            <button class="modal-close" id="key-modal-close" aria-label="Close">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="key-modal-body">
                <h3>Citation Quality & Status Key</h3>
                <div class="key-grid-modal">
                    <div class="key-column">
                        <div class="key-section-title">Event Status</div>
                        <div class="key-item">
                            <span class="status-badge verified">Verified</span>
                            <span class="key-description">Event/fact confirmed to have occurred</span>
                        </div>
                        <div class="key-item">
                            <span class="status-badge partial">Partial</span>
                            <span class="key-description">Some aspects confirmed, others uncertain</span>
                        </div>
                        <div class="key-item">
                            <span class="status-badge unverified">Unverified</span>
                            <span class="key-description">Event/fact not yet confirmed</span>
                        </div>
                    </div>
                    <div class="key-column">
                        <div class="key-section-title">Source Quality</div>
                        <div class="key-item">
                            <span class="quality-badge high">High</span>
                            <span class="key-description">Academic papers, official records, archives</span>
                        </div>
                        <div class="key-item">
                            <span class="quality-badge medium">Medium</span>
                            <span class="key-description">News articles, reputable websites, books</span>
                        </div>
                        <div class="key-item">
                            <span class="quality-badge low">Low</span>
                            <span class="key-description">Blogs, social media, anecdotal sources</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- REFERENCES MODAL                                                    -->
    <!-- Full screen modal for viewing all references with pagination        -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="references-modal">
        <div class="modal-content references-modal-content">
            <button class="modal-close" id="references-modal-close" aria-label="Close">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="references-modal-header">
                <div class="references-header-top">
                    <h2>References</h2>
                    <div class="header-buttons">
                        <button class="clear-filters-btn" id="clear-references-filters" style="display: none;">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                            </svg>
                            <span>Clear</span>
                        </button>
                        <button class="key-toggle-btn" id="toggle-references-key">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"/>
                            </svg>
                            <span>Key</span>
                        </button>
                    </div>
                </div>
                <div class="references-key-modal collapsed" id="references-key-modal">
                    <div class="key-grid-modal">
                        <div class="key-column">
                            <div class="key-section-title">Event Status</div>
                            <div class="key-item">
                                <span class="status-badge verified">Verified</span>
                                <span class="key-description">Confirmed to have occurred</span>
                            </div>
                            <div class="key-item">
                                <span class="status-badge partial">Partial</span>
                                <span class="key-description">Some aspects confirmed</span>
                            </div>
                            <div class="key-item">
                                <span class="status-badge unverified">Unverified</span>
                                <span class="key-description">Not yet confirmed</span>
                            </div>
                        </div>
                        <div class="key-column">
                            <div class="key-section-title">Source Quality</div>
                            <div class="key-item">
                                <span class="quality-badge high">High</span>
                                <span class="key-description">Academic papers, official records</span>
                            </div>
                            <div class="key-item">
                                <span class="quality-badge medium">Medium</span>
                                <span class="key-description">News articles, reputable websites</span>
                            </div>
                            <div class="key-item">
                                <span class="quality-badge low">Low</span>
                                <span class="key-description">Blogs, anecdotal sources</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="references-toolbar">
                    <div class="references-toolbar-row">
                        <div class="references-search">
                            <input type="text" class="references-search-input" placeholder="Search references..." aria-label="Search references">
                            <button class="search-clear-btn" id="clear-search" aria-label="Clear search" style="display: none;">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="references-toolbar-row">
                        <div class="references-filters">
                            <select class="references-filter" id="status-filter">
                                <option value="">All Status</option>
                                <option value="verified">Verified</option>
                                <option value="partial">Partial</option>
                                <option value="unverified">Unverified</option>
                            </select>
                            <select class="references-filter" id="quality-filter">
                                <option value="">All Quality</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                            <select class="references-filter" id="per-page">
                                <option value="10" selected>10 per page</option>
                                <option value="30">30 per page</option>
                                <option value="60">60 per page</option>
                                <option value="all">Show all</option>
                            </select>
                        </div>
                        <button class="clear-all-filters-btn" id="clear-all-filters" style="display: none;">Clear All</button>
                    </div>
                </div>
                <div class="references-status"></div>
            </div>
            <div id="references-modal-body" class="references-modal-body">
                <!-- References content will be inserted here -->
            </div>
            <div class="references-pagination">
                <!-- Pagination controls will be inserted here -->
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- ABOUT MODAL                                                         -->
    <!-- Information about the project, licenses, and credits                -->
    <!-- =================================================================== -->
    <div class="modal-overlay" id="about-modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close" aria-label="Close">
                <svg viewBox="0 0 24 24"></svg>
            </button>
            <div class="about-content">
                <div class="about-header">
                    <div class="about-logo">
                        <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 450 96" preserveAspectRatio="xMidYMid meet"></svg>
                    </div>
                    <h2>Gipsy Hill Timeline</h2>
                    <p class="about-tagline">A community-driven historical resource</p>
                </div>
                
                <div class="about-main">
                    <p class="about-description">
                        üìö <strong>Community-driven history</strong><br>
                        Help document Gipsy Hill's heritage. Share your memories and corrections.
                    </p>
                    
                    <div class="about-license">
                        <p><strong>Open Source ‚Ä¢ CC BY-NC-SA 4.0</strong></p>
                        <p class="about-links">
                            <a href="https://github.com/danieledge/Fogh-timeline" target="_blank">GitHub</a> ‚Ä¢ 
                            <a href="https://github.com/danieledge/Fogh-timeline/blob/main/LICENSE" target="_blank">License</a>
                        </p>
                    </div>
                    
                    <p class="about-warning">
                        ‚ö†Ô∏è <strong>Beta Version</strong> - Work in progress. Please report any issues or errors you find.
                    </p>
                </div>
                
                <div class="about-actions">
                    <a href="https://gipsyhillfriends.org" target="_blank" rel="noopener" class="about-action-link">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                        </svg>
                        <span>Visit FoGH Website</span>
                    </a>
                    <a href="mailto:info@gipsyhillfriends.org" class="about-action-link">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        <span>Contact Us</span>
                    </a>
                </div>
                
                <div class="about-footer">
                    <span class="version">v2.81a</span>
                    <button class="credits-toggle" onclick="this.parentElement.classList.toggle('show-credits')">
                        Icon Credits <svg viewBox="0 0 24 24" width="12" height="12"><path d="M7 10l5 5 5-5z"/></svg>
                    </button>
                    <div class="credits-panel">
                        <strong>Icon attributions:</strong><br>
                        Train (P. Rapolu) ‚Ä¢ Car Explosion (Icons Cart) ‚Ä¢ Police Helmet (P. Carleton) ‚Ä¢ Bunker (Saepul Nahwan) ‚Ä¢ Sudan (WEBTECHOPS) ‚Ä¢ River (rendicon) ‚Ä¢ Trees (asianson.design) ‚Ä¢ POI (M. Sturk) ‚Ä¢ Bomb (SyarifahFunny) ‚Ä¢ Cow Head (ain) ‚Ä¢ Roman (tulpahn) ‚Ä¢ Helmet (Robert Bjurshagen)<br>
                        <em>All icons from <a href="https://thenounproject.com" target="_blank">Noun Project</a> under CC BY 3.0</em>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- THEME INITIALIZATION SCRIPT                                         -->
    <!-- Sets theme before page renders to prevent flash                     -->
    <!-- =================================================================== -->
    <script>
        // Set theme immediately to prevent flash
        (function() {
            var savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
        
        // Register service worker for better cache management
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js?v=' + APP_VERSION)
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                        
                        // Check for updates on page focus
                        document.addEventListener('visibilitychange', function() {
                            if (!document.hidden) {
                                registration.update();
                            }
                        });
                        
                        // Handle updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('A new version is available! Reload to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    
    <!-- =================================================================== -->
    <!-- JAVASCRIPT LOADING                                                  -->
    <!-- Loads timeline data and functionality scripts in sequence           -->
    <!-- =================================================================== -->
    <!-- =================================================================== -->
    <!-- Load external JavaScript files with cache busting -->
    <script>
        (function() {
            var cacheBust = window.cacheBust || '';
            
            // Load scripts sequentially to ensure proper order
            function loadScript(src, callback) {
                var script = document.createElement('script');
                script.src = src + cacheBust;
                script.onload = function() {
                    if (callback) callback();
                };
                script.onerror = function() {
                    console.error('Failed to load script: ' + src);
                    document.getElementById('loading').textContent = 'Error loading timeline scripts.';
                };
                document.body.appendChild(script);
            }
            
            // Load scripts in sequence - Leftline BEFORE timeline-main
            loadScript('timeline-data.js', function() {
                console.log('[TIMELINE] Data loaded, loading Leftline carousel...');
                loadScript('New_leftline.bundle.js?v=' + Date.now(), function() {
                    console.log('[TIMELINE] Leftline loaded, version:', window.Leftline ? window.Leftline.version : 'UNKNOWN');
                    if (window.Leftline && window.Leftline.version !== '1.3-ZOOM') {
                        console.warn('[TIMELINE] WARNING: Old version of Leftline loaded! Expected: 1.3-ZOOM, Got:', window.Leftline.version);
                        console.warn('[TIMELINE] Clear cache: Ctrl+Shift+Delete or hard refresh: Ctrl+Shift+R');
                    }
                    // Now load timeline-main AFTER Leftline is ready
                    loadScript('timeline-main.js', function() {
                        console.log('[TIMELINE] Main timeline script loaded');
                        loadScript('staticman-integration.js', function() {
                            console.log('All scripts loaded');
                            // Force mount all carousels after everything is loaded
                            setTimeout(function() {
                                if (window.Leftline && window.Leftline.mountAll) {
                                    console.log('[TIMELINE] Force mounting all carousels...');
                                    window.Leftline.mountAll(document);
                                    var carousels = document.querySelectorAll('.leftline-carousel');
                                    console.log('[TIMELINE] Found', carousels.length, 'carousels after page load');
                                }
                            }, 500);
                        });
                    });
                });
            });
        })();
    </script>
</body>
</html>
